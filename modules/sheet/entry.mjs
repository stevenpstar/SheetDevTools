var p=class{constructor(e,t,n,o){this.x=e,this.y=t,this.width=n,this.height=o}IsHovered(e,t,n){return this.height<0?e>=this.x+n.x&&e<=this.x+n.x+this.width&&t>this.y-Math.abs(this.height)+n.y&&t<=this.y+n.y:e>=this.x+n.x&&e<=this.x+n.x+this.width&&t>=this.y+n.y&&t<=this.y+n.y+this.height}};var V=class{constructor(e){this.Num=e,this.Buffer=this.Num*1e3,this.TopLine=5,this.BotLine=35,this.MidLine=15}};function N(i,e=-1){if(!i){console.log("Staves does not exist? Early return");return}if(i.length===0)return console.log("No staves found, early return"),0;let t=0;return i.forEach((n,o)=>{if(o<e||e===-1){let r=n.TopLine<0?n.BotLine+Math.abs(n.TopLine):n.BotLine-n.TopLine;t+=r*5}}),t}function Ge(i,e){let t=i.find(s=>s.Num===e);return t?(t.TopLine<0?t.BotLine+Math.abs(t.TopLine):t.BotLine-t.TopLine)*5:(console.error("Cannot find staff: ",e),-1)}function y(i,e){let n=i.find(o=>o.Num===e);return 0+(n.MidLine-n.TopLine)}var _=class{constructor(e,t){this.ID=0,this.Selected=!1,this.SelType=8,this.Bounds=new p(0,0,0,0),this.Editable=!1,this.Position=e,this.Type=t}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}};function se(i,e,t,n){if(i.context.fillStyle=i.theme.LineColour,e){if(!t){switch(e.Barlines[1].Type){case 0:Y(i,e,n,e.Barlines[1].Position);break;case 4:Ve(i,e,n);break;case 2:At(i,e,n);break;default:Y(i,e,n,e.Barlines[1].Position)}return}}else{switch(t.Barlines[0].Selected&&(i.context.fillStyle=i.theme.SelectColour),t.Barlines[0].Type){case 0:Y(i,t,n,t.Barlines[0].Position);break;case 4:Ve(i,t,n);break;default:Y(i,t,n,t.Barlines[0].Position)}return}e.Barlines[1].Type==0&&t.Barlines[0].Type==0&&Y(i,t,n,t.Barlines[0].Position)}function Y(i,e,t,n){let s=y(e.Staves,0),r=e.Bounds.y+N(e.Staves,0)+s*5-4*5,a=e.Bounds.y+N(e.Staves,e.Staves.length-1)+s*5+4*5-r;var u=e.Bounds.x;n==1&&(u+=e.GetBoundsWithOffset().width),u=Math.floor(u);let f=`M${u+t.x}
      ${r+t.y} h
      1 v ${a} h -1 Z`;i.context.fill(new Path2D(f))}function At(i,e,t){let o=y(e.Staves,0),s=e.Bounds.y+N(e.Staves,0)+o*5-4*5,l=e.Bounds.y+N(e.Staves,e.Staves.length-1)+o*5+4*5-s;var a=e.Bounds.x+e.GetBoundsWithOffset().width;let u=`M${a+t.x-9}
      ${s+t.y} h
      1 v ${l} h -1 Z`,f=`M${a+t.x-4}
      ${s+t.y} h
      4 v ${l+1} h -4 Z`;i.context.fill(new Path2D(u)),i.context.fill(new Path2D(f))}function Ve(i,e,t){let o=y(e.Staves,0),s=e.Bounds.y+N(e.Staves,0)+o*5-4*5,l=e.Bounds.y+N(e.Staves,e.Staves.length-1)+o*5+4*5-s;var a=e.Bounds.x+e.GetBoundsWithOffset().width;let u=`M${a+t.x-9}
      ${s+t.y} h
      1 v ${l} h -1 Z`,f=`M${a+t.x-4}
      ${s+t.y} h
      4 v ${l+1} h -4 Z`,h="a1.485 1.485 90 10-2.97 0 1.485 1.485 90 102.97 0";i.context.fill(new Path2D(u)),i.context.fill(new Path2D(f)),e.Staves.forEach(m=>{let c=y(e.Staves,m.Num),d=N(e.Staves,m.Num)+e.Bounds.y+c*5,b=`m${a-12+i.camera.x} ${d+.5+i.camera.y-5}`+h,S=`m${a-12+i.camera.x} ${d+.5+i.camera.y+5}`+h;i.context.fill(new Path2D(b)),i.context.fill(new Path2D(S))})}function Oe(i,e){let t=!0;switch(e){case 0:case 1:break;case 2:case 4:t=i===1;break;case 3:t=i===0;break;default:break}return t}var re=(a=>(a[a.None=0]="None",a[a.Selection=1]="Selection",a[a.Deletion=2]="Deletion",a[a.InputChange=3]="InputChange",a[a.AddNote=4]="AddNote",a[a.Undo=5]="Undo",a[a.Redo=6]="Redo",a[a.StateChange=7]="StateChange",a))(re||{});function Q(){return{messageString:"",messageData:{MessageType:0,Message:{msg:"",obj:{}}}}}var R=40;function E(i,e,t,n,o,s){let{context:r,camera:l}=i;r.fillStyle=s?o.SelectColour:o.NoteElements,r.font=`${R}px Bravura`,r.fillText(e,t+l.x,n+l.y)}function ae(i,e,t,n,o,s,r){let{context:l,camera:a}=i;var u=s?o.SelectColour:o.NoteElements;l.fillStyle=s?o.SelectColour:o.NoteElements,l.font=`${r}px Bravura`,l.fillText(e,t+a.x,n+a.y)}function w(i,e,t,n,o,s,r,l){let{context:a,camera:u}=e;var f=r?s.SelectColour:s.NoteElements;i.OutOfBounds&&(f="red"),a.fillStyle=f,a.font=`${l}px Bravura`,a.fillText(t,n+u.x,o+u.y)}var q=new Map([[1,1],[.5,.5],[.25,.25],[.125,.125],[.0625,.0625],[.03125,.03125]]);function J(i){let e=i,t=[];if(!(i%.03125===0)){console.error("Not divisible by standard value, not implemented. Value: ",i);return}for(q.has(i)&&(t.push(i),e-=i,e!==0&&console.error("HUH?"));e>0;){for(let[o,s]of q)q.get(o)<=e&&(t.push(q.get(o)),e-=q.get(o));e<.03125&&(e=0)}return t}var ee=9;function ue(i,e,t,n,o,s,r,l="black"){let{x:a,y:u,width:f,height:h}=t,{context:m,camera:c}=e;u=u+3,l=i.Editable?r.NoteElements:r.UneditableColour,l=n?r.SelectColour:l;let d=i.Grace?Math.floor(R*.6):R;switch(i.Duration){case .125:case .25:i.Opacity<1&&(i.Opacity+=.01),w(i,e,"\uE0A4",a,u,r,n,d);break;case .5:w(i,e,"\uE0A3",a,u,r,n,d);break;case 1:w(i,e,"\uE0A2",a-2.5,u,r,n,d);break;default:w(i,e,"\uE0A4",a,u,r,n,d)}m.fillStyle=r.NoteElements,n&&(m.fillStyle=r.SelectColour),!1&&(m.fillStyle="rgba(200, 0, 0, 0.5)",m.fillRect(a+c.x,u+c.y-5,f,h),m.fillStyle=r.NoteElements)}function le(i,e,t,n,o,s,r){if(!o)return;e.fillStyle=r.NoteElements;let l=t.Bounds.x+ee,a=s.GetNotePositionOnLine(o.Line+3.5,o.Staff),u=`m${l} ${a}`;if(e.fillStyle=o.Selected?r.SelectColour:r.NoteElements,t.Duration===.015625){let f=s.GetNotePositionOnLine(o.Line+3.5,o.Staff);w(o,i,"\uE4E9",l,f+1,r,o.Selected,R)}if(t.Duration>.015625&&t.Duration<=.03125){let f=s.GetNotePositionOnLine(o.Line+5,o.Staff);w(o,i,"\uE4E8",l,f+1,r,o.Selected,R)}else if(t.Duration>.03125&&t.Duration<=.0625){let f=s.GetNotePositionOnLine(o.Line+5,o.Staff);w(o,i,"\uE4E7",l,f+1,r,o.Selected,R)}else if(t.Duration>.0625&&t.Duration<=.125){let f=s.GetNotePositionOnLine(o.Line+5,o.Staff);w(o,i,"\uE4E6",l,f+1,r,o.Selected,R)}else if(t.Duration===.25){let f=s.GetNotePositionOnLine(o.Line+5.5,o.Staff);w(o,i,"\uE4E5",l,f+1,r,o.Selected,R)}else if(t.Duration===.5){let f=s.GetNotePositionOnLine(o.Line+4.5,o.Staff);w(o,i,"\uE4E4",l,f+1,r,o.Selected,R)}else t.Duration>=1&&(l=t.Bounds.x+t.Bounds.width/2,w(o,i,"\uE4E3",l,a+1,r,o.Selected,R))}function wt(i,e,t,n){let{context:o,camera:s}=i,r=e.x2-e.x1;o.fillStyle="#75757",o.fillRect(e.x1+s.x,e.y1-12+s.y,1,6),o.fillRect(e.x1+s.x,e.y1-12+s.y,r/2-14,1),o.fillRect(e.x1+r+s.x,e.y1-12+s.y,1,6),o.fillRect(e.x1+r/2+14+s.x,e.y1-12+s.y,r/2-14,1),E(i,Gt(t),e.x1+r/2-7,e.y1-5,n,!1)}function Gt(i){switch(i){case"0":return"\uE880";case"1":return"\uE881";case"2":return"\uE882";case"3":return"\uE883";case"4":return"\uE884";case"5":return"\uE885";case"6":return"\uE886";case"7":return"\uE887";case"8":return"\uE888";case"9":return"\uE889";default:return"\uE883"}}function ve(i,e,t,n,o,s){let{context:r,camera:l}=i,a=e.filter(d=>d.Staff===n);a.sort((d,b)=>d.Beat-b.Beat);let u=!1,f=0,h=0,m=0,c=0;a.forEach((d,b)=>{let S=t.filter(C=>C.Beat===d.Beat&&C.Staff===n),g=[...S],B=O([S],[d]);if(!S[0].Tuple){u&&(u=!1,wt(i,{x1:f,y1:m,x2:h,y2:m},c.toString(),s),f=0,h=0,m=0,c=0);return}u||(u=!0,f=d.Bounds.x+9,c=S[0].TupleDetails.Count,m=d.Bounds.y),h=d.Bounds.x+19})}function Me(i,e,t,n,o){let{context:s,camera:r}=i,l=e.filter(a=>a.Staff===n);l.sort((a,u)=>a.Beat-u.Beat),l.forEach((a,u)=>{if(u===l.length-1)return;let f=t.filter(m=>m.Beat===a.Beat);f.sort((m,c)=>m.Line-c.Line);let h=t.filter(m=>m.Beat===l[u+1].Beat);h.sort((m,c)=>m.Line-c.Line),f.forEach(m=>{if(!m.Tied||m.Rest||m.Tied&&m.Beat+m.Duration*o.TimeSignature.bottom>m.TiedEnd)return;let c=h.find(T=>T.Line===m.Line&&T.Tied&&T.Beat<=T.TiedEnd);if(c===void 0){console.error("No tied note found: ",m);return}let d=c,b=a.Bounds.x+ee+r.x+3,S=o.GetNotePositionOnLine(m.Line,m.Staff)+r.y-4,g=l[u+1].Bounds.x+ee+r.x+3,B=o.GetNotePositionOnLine(d.Line,m.Staff)+r.y,C=g-(g-b)/2,M=g-b,L=m.Line<15?-15:15,A=m.Line<15?-8:8,D=m.Line<15?-20:20,U=m.Line<15?-17:17,j=`
      m ${b} ${S} q ${M/2} ${D} ${M} 0 q -${M/2} ${U} -${M} 0 z
      //      `;s.fill(new Path2D(j))})})}function O(i,e){let t=0;i.sort((l,a)=>l[0].Beat-a[0].Beat);let n=!0;if(e.forEach((l,a)=>{l.Beat!==i[a][0].Beat&&(console.error("Index: ",a),console.error("Match failed on div: ",l),console.error("Match failed on beat: ",l.Beat),console.error("Match fail note: ",i[a][0]),n=!1)}),!n){console.error("Divisions and note array do not match");return}let o=15,s=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER;return i.forEach(l=>{l.forEach(a=>{a.Line<s&&(s=a.Line),a.Line>r&&(r=a.Line)})}),o-s<r-o?t=0:t=1,t}function Te(i,e,t,n,o,s,r){let{context:l,camera:a}=t,u=ee,h=o.Voices[o.ActiveVoice].Notes.filter(B=>B.Beat===e.Beat&&B.Staff===e.Staff).filter(B=>B.Accidental!==0).length;h>0&&(u+=ee*h-1);let m=e.Bounds.x+u-6+a.x,c="h 22 v 1.5 h-20 v-1.5 Z",d=i.filter(B=>B.Beat===e.Beat&&B.Staff===e.Staff),b=15;if(d.length===0)return;d.sort((B,C)=>B.Line-C.Line);let S=d[0],g=d[d.length-1];l.fillStyle=s.NoteElements;for(let B=b-6;B>=S.Line;B-=2){let C=o.GetNotePositionOnLine(B,n)+a.y+2.5,M=`m ${m} ${C}`+c;l.fill(new Path2D(M))}for(let B=b+6;B<=g.Line;B+=2){let C=o.GetNotePositionOnLine(B,n)+a.y+2.5,M=`m ${m} ${C}`+c;l.fill(new Path2D(M))}}var G=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],fe=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],Vt=new Map([["treble",16],["bass",4]]);function ke(i){return Math.floor(440*Math.pow(2,(i-69)/12)*1e3)/1e3}function Hi(i,e,t=0){let n=0,o=69,s=0,r=t===0?16:34,l=r;if(e===o)return r;if(e>o)for(let a=o;a<e;a++)G[n]==="C"||G[n]==="F"?(l-=0,n===0?n=G.length-1:n-=1):(l-=1,n-=1);else if(o>e)for(let a=o;a>e;a--)G[n]==="B"||G[n]==="E"?(l+=0,n===G.length-1?n=0:n+=1):(l+=1,n+=1);return l}function Fe(i,e,t=0,n=0){let o=0,s=Vt.get(i),r=69,l=r;if(e===s)return r+t;if(e>s)for(let a=s;a<e;a++)G[o]==="C"||G[o]==="F"?(l-=1,o-=1):(o===0?o=G.length-2:o-=2,l-=2);else for(let a=s;a>e;a--)G[o]==="B"||G[o]==="E"?(l+=1,o===G.length-1?o=0:o+=1):(l+=2,o+=2);return l+=t,l}function he(){let i=new Map,e=new Map,t=0,n=1,o=43,s=0,r=11;for(let l=24;l<=127;l++)t>=fe.length&&(t=0,n++),o=[0,2,3,5,7,8,10].includes(s)?o-1:o,i.set((fe[t]+n).toString(),ke(l)),e.set(l,{NoteString:(fe[t]+n).toString(),Frequency:ke(l),Line:o,Accidental:fe[t].includes("#")?1:0}),t++,s>=r?s=0:s++;return console.log("midiMap: ",e),e}function Ue(i,e,t){let n=e.get(i),o={NoteString:n.NoteString,Line:n.Line,Frequency:n.Frequency,Accidental:n.Accidental};return t==="bass"&&(o.Line-=12),o}var v=class{constructor(e){this.Voice=e.Voice,this.Beat=e.Beat,this.Order=0,e.Grace||(this.Order=this.Beat),this.Duration=e.Duration,this.Line=e.Line,this.Rest=e.Rest,this.Tied=e.Tied,this.Accidental=e.Accidental,this.Staff=e.Staff,this.Clef=e.Clef,this.Grace=e.Grace,this.OutOfBounds=!1,this.Selected=!1,this.SelType=1,this.Bounds=new p(0,0,0,0),this.Bounds.width=12,this.Bounds.height=10,this.Editable=e.Editable!==void 0?e.Editable:!0,this.ID=-1,this.Tuple=e.Tuple,e.TupleDetails&&(this.TupleDetails=e.TupleDetails),this.Opacity=1}SetBounds(e){this.Bounds=e}SetID(e){this.ID=e}SetTiedStartEnd(e,t){this.TiedStart=e,this.TiedEnd=t}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}GetMidiNumber(){let e=this.Staff===0?this.Line:this.Line-1e3;return Fe(this.Clef,e,this.Staff)}};var He=30,Ze=40;function Xe(i,e,t,n,o){let s=[],r=0,l=0;if(e.sort((a,u)=>a.Beat-u.Beat),e.filter(a=>a.Staff===t&&a.Grace===!1).length===0){let a={Beat:1,Duration:1*(i.TimeSignature.top/i.TimeSignature.bottom),Line:y(i.Staves,t),Rest:!0,Tied:!1,Staff:t,Tuple:!1,Clef:t===0?"treble":"bass",Grace:!1,Voice:o,Accidental:0};i.AddNote(new v(a),!1,n)}return e.filter(a=>a.Staff===t&&a.Grace===!1&&a.Voice===o).forEach(a=>{a.Beat>=i.TimeSignature.top+1?a.OutOfBounds=!0:a.OutOfBounds=!1,s.find(u=>u.Beat===a.Beat&&u.Staff===a.Staff)||(s.push(Ot(i,a,t,0)),a.Tuple?r=a.Beat+a.Duration/a.TupleDetails.Count*i.TimeSignature.bottom:r=a.Beat+a.Duration*i.TimeSignature.bottom,l+=a.Duration)}),Ft(i,s,t,n,o),s.filter(a=>a.Staff===t).forEach(a=>{let u=i.Clefs.find(f=>f.Staff===a.Staff&&f.Beat===a.Beat);kt(a,e.filter(f=>f.Beat===a.Beat),u)}),k(i,t),s}function Ot(i,e,t,n){var o={Beat:e.Beat,Duration:e.Duration,Bounds:Le(i,e.Beat,e.Duration,t),Staff:t,StaffGroup:e.StaffGroup,Direction:n,NoteXBuffer:0,Subdivisions:[]};return o}function kt(i,e,t){i.Subdivisions=[];let n=t!==void 0,o=n&&t.PostClef===!1?30:0,s=n&&t.PostClef===!0?30:0;i.Beat===1&&(o=0);let r={Order:1,Type:0,Bounds:new p(i.Bounds.x,i.Bounds.y,o,i.Bounds.height)};i.Subdivisions.push(r),e.forEach(f=>{if(f.Grace&&!i.Subdivisions.find(h=>h.Type===1)){let h={Order:2,Type:1,Bounds:new p(i.Bounds.x+o,i.Bounds.y,15,i.Bounds.height)};i.Subdivisions.push(h)}});var l=0;i.Subdivisions.forEach(f=>{l+=f.Bounds.width});let a={Order:3,Type:2,Bounds:new p(i.Bounds.x+l,i.Bounds.y,i.Bounds.width-l-s,i.Bounds.height)};i.Subdivisions.push(a);let u={Order:4,Type:3,Bounds:new p(i.Bounds.x+i.Bounds.width-s,i.Bounds.y,s,i.Bounds.height)};i.Subdivisions.push(u),i.Subdivisions.sort((f,h)=>h.Order-f.Order)}function Le(i,e,t,n){let o=i.TimeSignature.GetMaxDuration(),s=t/o,r=i.Bounds.width*s,l=Ge(i.Staves,n),a=i.Bounds.x+i.XOffset+(e-1)/i.TimeSignature.bottom*i.Bounds.width,u=i.Bounds.y+N(i.Staves,n);return new p(a,u,r,l)}function _e(i,e,t){let n=e.filter(o=>o.Staff===t);n.sort((o,s)=>o.Beat-s.Beat),n.forEach((o,s)=>{if(o.Bounds.width=o.Duration*i.Bounds.width,s>0){let r=n[s-1].Bounds.x+n[s-1].Bounds.width;r!==o.Bounds.x&&(o.Bounds.x=r)}s===0&&n.length===1&&(o.Bounds.width=i.Bounds.width)})}function Ft(i,e,t,n,o){let s=e.sort((d,b)=>d.Beat-b.Beat),r=1,l=[];s.filter(d=>d.Staff===t).forEach(d=>{let b=n.Notes.filter(S=>S.Beat===d.Beat);if(d.Beat===r)r=d.Beat+d.Duration*i.TimeSignature.bottom,b[0].Tuple&&(r=b[0].TupleDetails.EndBeat);else if(d.Beat>=r){let S=(d.Beat-r)/i.TimeSignature.bottom,g=J(S),B=r;g.sort(),g.forEach(C=>{l.push({Beat:B,Duration:C,Bounds:Le(i,B,C,d.Staff),Staff:d.Staff,StaffGroup:b[0].StaffGroup,Direction:0,NoteXBuffer:0,Subdivisions:[]}),B+=C*i.TimeSignature.bottom}),r=d.Beat+d.Duration*i.TimeSignature.bottom}}),e.push(...l),l.forEach(d=>{n.Notes.find(B=>B.Beat===d.Beat&&B.Staff===d.Staff)!==void 0&&console.error("Note found in division gap");let S=P(i,d.Beat,t),g={Beat:d.Beat,Duration:d.Duration,Line:y(i.Staves,t),Rest:!0,Tied:!1,Staff:d.Staff,Tuple:!1,Clef:S,Grace:!1,Voice:o,Accidental:0};i.AddNote(new v(g),!1,n)});let a=i.TimeSignature.top/i.TimeSignature.bottom*i.TimeSignature.bottom+1,u=e.filter(d=>d.Staff===t);u=e.sort((d,b)=>d.Beat-b.Beat);let f=u[u.length-1],h=f.Beat+f.Duration*i.TimeSignature.bottom,m=[],c=a-h;if(c>0){let d=c/i.TimeSignature.bottom,b=J(d),S=h;b.sort(),b.forEach(g=>{m.push({Beat:S,Duration:g,Bounds:Le(i,S,g,f.Staff),Staff:t}),S+=g*i.TimeSignature.bottom})}e.push(...m),m.forEach(d=>{i.Voices[i.ActiveVoice].Notes.find(B=>B.Beat===d.Beat&&B.Staff===d.Staff)!==void 0&&console.error("Note found in division gap");let S=P(i,d.Beat,t),g={Beat:d.Beat,Duration:d.Duration,Line:y(i.Staves,t),Rest:!0,Tied:!1,Staff:d.Staff,Tuple:!1,Clef:S,Grace:!1,Voice:i.ActiveVoice,Accidental:0};i.AddNote(new v(g))})}function $e(i,e,t){let n={DivGroups:[]},o=[],s=[],r=!1,l=!1,a=i.Voices[t].Divisions.filter(u=>u.Staff===e||u.StaffGroup===e).sort((u,f)=>u.Beat-f.Beat);return a.forEach(u=>{let f=i.Voices[t].Notes.filter(h=>h.Beat===u.Beat&&(h.Staff===e||h.StaffGroup===e)&&h.Grace);f.length>0&&n.DivGroups.push(H([u],[f],e,r))}),a.forEach((u,f)=>{u.Staff!==e&&(r=!0);let h=i.Voices[t].Notes.filter(c=>c.Beat===u.Beat&&(c.Staff===e||c.StaffGroup===e)&&!c.Grace);h.sort((c,d)=>c.Line-d.Line);let m=Ee(u.Beat,h,e);m&&l?(n.DivGroups.push(H(o,s,e,r)),o=[],s=[],l=!1):m||(l?u.Duration>.125?(l=!1,n.DivGroups.push(H(o,s,e,r)),o=[],s=[],o.push(u),s.push(h),n.DivGroups.push(H(o,s,e,r)),o=[],s=[]):(i.TimeSignature.Breakpoints.includes(u.Beat)&&(n.DivGroups.push(H(o,s,e,r)),o=[],s=[]),o.push(u),s.push(h),f===i.Voices[t].Divisions.filter(c=>c.Staff===e||c.StaffGroup===e).length-1&&(n.DivGroups.push(H(o,s,e,r)),o=[],s=[])):(o.push(u),s.push(h),u.Duration>.125?(n.DivGroups.push(H(o,s,e,r)),o=[],s=[]):(l=!0,f===i.Voices[t].Divisions.filter(c=>c.Staff===e||c.StaffGroup===e).length-1&&(n.DivGroups.push(H(o,s,e,r)),o=[],s=[]))))}),n.DivGroups}function H(i,e,t,n){let o=O(e,i);return{Divisions:i,Notes:e,CrossStaff:n,Staff:t,Stems:[],Flags:[],Beams:[],StemDir:o}}function Ee(i,e,t){var o=!e.filter(s=>s.Beat===i&&(s.Staff===t||s.StaffGroup===t)).find(s=>!s.Rest);return o===void 0&&(o=!1),o}var I=class{constructor(e,t,n,o,s=!1){this.ID=e,this.Position={x:0,y:0},this.Staff=o,this.Bounds=new p(0,0,0,0),this.Type=t,this.SelType=2,this.Beat=n,this.Selected=!1,this.Editable=!0,this.PostClef=s}render(e,t){let n;switch(this.Type){case"treble":n="\u{1D11E}";break;case"bass":n="\u{1D122}";break;default:n="\u{1D11E}"}let o=this.Beat==1?R*1:R*.65;ae(e,n,this.Position.x,this.Position.y,t,this.Selected,o)}SetBounds(e,t){let n=e.Voices[e.ActiveVoice].Divisions.find(u=>u.Beat===this.Beat&&u.Staff===t),o=e.Bounds.x;if(this.Beat!==1&&n)if(this.PostClef){let u=n.Subdivisions.find(f=>f.Type===3);u?o=u.Bounds.x:o=n.Bounds.x}else{let u=n.Subdivisions.find(f=>f.Type===0);u?o=u.Bounds.x:o=n.Bounds.x}e.PrevMeasure&&(e.PrevMeasure.PageLine,e.PageLine);let s=3,r=2,l=0,a=y(e.Staves,t);switch(this.Position.x=o+s,this.Bounds.x=o+s,this.Type){case"bass":r=-2}this.Position.y=n.Bounds.y+l+(a+r)*5,this.Bounds.y=n.Bounds.y,this.Bounds.width=30,this.Bounds.height=85}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}};function P(i,e,t){let n=t===0?"treble":"bass";return t===0&&(i.Clefs.sort((o,s)=>o.Beat-s.Beat),i.Clefs.forEach(o=>{if(o.Beat<=e){n=o.Type;return}})),n}var xe=class{constructor(e,t,n,o=1){this.Selected=!1;this.SelType=7;this.Selected=!1,this.Editable=!1,this.Direction=t,this.Duration=n,this.Bounds=this.SetBounds(e),this.Scale=o}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}SetBounds(e){let t=e.height;return this.Duration<=.03125&&(t=this.Direction===0?t-6:t+6),new p(e.x+1,e.y+t,10,30)}Render(e,t){ae(e,Ht(this.Duration,this.Direction),this.Bounds.x,this.Bounds.y,t,this.Selected,Math.floor(40*this.Scale))}RenderBounds(e,t){e.strokeStyle="rgba(255, 0, 0, 255)",e.strokeRect(this.Bounds.x+t.x,this.Bounds.y+t.y,this.Bounds.width,this.Bounds.height)}};function Ht(i,e){return i<.25&&i>=.125?e===0?"\uE241":"\uE240":i<.125&&i>=.0625?e===0?"\uE243":"\uE242":i<.0625&&i>=.03125?e===0?"\uE245":"\uE244":i<.03125?e===0?"\uE247":"\uE246":e===0?"\uE241":"\uE240"}function ze(i){let e=[],t=!1,n=0,o=1;return i.Notes.length===0?[]:i.Notes[0].length===0?[]:i.Notes[0][0].Grace&&(t=!0,o=.6,i.Notes[0][0].Duration>=.25)?[]:i.Divisions[0].Duration>=.25&&!t?[]:(i.Stems.forEach(s=>{t?n=i.Notes[0][0].Duration:n=s.Division.Duration;let r=1;r=i.StemDir===0?1:0,e.push(new xe(s.Bounds,r,n,o))}),e)}function We(i,e,t){let n=e.Divisions.sort((o,s)=>o.Beat-s.Beat);if(t===0){if(e.Notes.length===0)return 4;let o=e.Notes[0].sort((r,l)=>r.Line-l.Line)[0].Line,s=e.Notes[e.Notes.length-1].sort((r,l)=>r.Line-l.Line)[0].Line;if(o===s)return 4;if(o<s)return 2;if(o>s)return 0}else{if(e.Notes.length===0)return 4;let o=e.Notes[0].sort((r,l)=>r.Line-l.Line)[e.Notes[0].length-1].Line,s=e.Notes[e.Notes.length-1].sort((r,l)=>r.Line-l.Line)[e.Notes[e.Notes.length-1].length-1].Line;if(o===s)return 4;if(o<s)return 0;if(o>s)return 2}return 4}function Ke(i,e,t,n){let o=t===0?-6:6,r=(t===0?8:-8)*n;return`M ${i.StartPoint.x+e.x+1} ${i.StartPoint.y+e.y-o+r}
        L${i.EndPoint.x+e.x+1} ${i.EndPoint.y+e.y-o+r}
        V${i.EndPoint.y+e.y+r} 
        L${i.StartPoint.x+e.x+1} ${i.StartPoint.y+e.y+r} z `}var Z=class{constructor(e,t,n,o=1){this.Selected=!1;this.SelType=5;this.Editable=!1;this.Bounds=e,this.StartPoint=t,this.EndPoint=n,this.Count=o,this.ID=0}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}Render(e,t,n,o,s){e.fillStyle=s.NoteElements,this.Selected&&(e.fillStyle=s.SelectColour);let r=Ke(this,t,o,0);e.fill(new Path2D(r));for(let l=1;l<this.Count;l++)e.fill(new Path2D(Ke(this,t,o,l)))}RenderBounds(e,t){e.strokeStyle="green",e.strokeRect(this.Bounds.x+t.x,this.Bounds.y+t.y,this.Bounds.width,this.Bounds.height),e.stroke()}static BeamCount(e,t=!1){let n=0;return e>=.25||(e>=.03125&&e<.0625?n=3:e>=.0625&&e<.125?n=2:n=1,t&&(n-=1)),n}};function je(i,e,t){let n=[];if(i.Divisions.length<=1)return n;let o=!0,s=null,r=O(i.Notes,i.Divisions);return i.Divisions.forEach((l,a)=>{if(a>e.length||e.length==0)return;let u=a==0?e[a]:e[a-1],f=e[a];if(o||Z.BeamCount(l.Duration,t)!==n[n.length-1].Count&&(o=!0),o){let m=Z.BeamCount(l.Duration,t);s=new Z(new p(0,0,0,0),{x:u.Bounds.x,y:u.Bounds.y+u.Bounds.height},{x:f.Bounds.x,y:f.Bounds.y+f.Bounds.height},m),n.push(s),o=!1}else s.EndPoint={x:f.Bounds.x,y:f.Bounds.y+f.Bounds.height};s.Bounds.x=s.StartPoint.x+1;var h=0;s.Count>1&&(h=2*(s.Count-1)),s.Bounds.width=s.EndPoint.x-s.StartPoint.x,r==0?s.StartPoint.y>s.EndPoint.y?(s.Bounds.y=s.EndPoint.y,s.Bounds.height=s.StartPoint.y-s.EndPoint.y+6*s.Count+h):(s.Bounds.y=s.StartPoint.y,s.Bounds.height=s.EndPoint.y-s.StartPoint.y+6*s.Count+h):r===1&&(s.StartPoint.y>s.EndPoint.y?(s.Bounds.y=s.EndPoint.y-6*s.Count-h,s.Bounds.height=s.StartPoint.y-s.EndPoint.y+6*s.Count+h):(s.Bounds.y=s.StartPoint.y-6*s.Count-h,s.Bounds.height=s.EndPoint.y-s.StartPoint.y+6*s.Count+h))}),n}var te=new Map([["CMaj/Amin",[]],["GMaj/Emin",["F#"]],["DMaj/Bmin",["F#","C#"]],["AMaj/F#min",["F#","C#","G#"]],["EMaj/C#min",["F#","C#","G#","D#"]],["BMaj/G#min",["F#","C#","G#","D#","A#"]],["F#Maj/D#min",["F#","C#","G#","D#","A#","E#"]],["C#Maj/A#min",["F#","C#","G#","D#","A#","E#","B#"]],["FMaj/Dmin",["Bb"]],["BbMaj/Gmin",["Bb","Eb"]],["EbMaj/Cmin",["Bb","Eb","Ab"]],["AbMaj/Fmin",["Bb","Eb","Ab","Db"]],["DbMaj/Bbmin",["Bb","Eb","Ab","Db","Gb"]],["GbMaj/Ebmin",["Bb","Eb","Ab","Db","Gb","Cb"]],["CbMaj/Abmin",["Bb","Eb","Ab","Db","Gb","Cb","Fb"]]]);var ie=12;function Qe(i){let e=[],t=i.filter(n=>n.Accidental!==0);switch(t.sort((n,o)=>n.Line-o.Line),t.length){case 0:return[];case 1:return[ie];case 2:return[ie,ie*2];default:Math.abs(t[0].Line-t[t.length-1].Line)>4,e=Ye(t)}return e}function Ye(i){let e=[];return i.forEach((t,n)=>{n===0?e.push(ie):e.push((i.length+1-n)*ie)}),e}var _t="c-1.2495-.1955-2.5177-.1955-3.7791-.1938-.0272-.9231.1207-1.904-.2448-2.771-.2448-.5763-.7089-1.0302-1.1203-1.4977-.6579.5882-1.1985 1.3651-1.2512 2.2678-.051.6664-.0136 1.3345-.0255 2.0009-1.2614.0187-2.5347-.0425-3.7791.2057.2397-1.2376.1853-2.5024.2074-3.7553.9605-.0255 1.9873.1122 2.8798-.306.5253-.2465.9724-.6324 1.4178-.9996-.5814-.6579-1.3362-1.2376-2.2474-1.292-.6817-.0544-1.3668-.0153-2.0502-.0272-.0425-1.2444.102-2.5024-.1564-3.7315 1.2308.2227 2.4854.1649 3.7281.1819.0187.8857-.0799 1.8037.17 2.6554.1904.6511.7106 1.1526 1.1441 1.666.6137-.5338 1.1662-1.2036 1.2665-2.0417.0918-.7582.0187-1.5198.0612-2.2797 1.2529-.034 2.5432.1258 3.7553-.2703-.1802 1.2631-.1972 2.5466-.1836 3.8199-.8942.0255-1.8309-.0748-2.6809.2278-.646.2278-1.1543.7276-1.6677 1.1696.5576.5712 1.2291 1.0965 2.0587 1.1747.7616.0714 1.5266.0391 2.2899.0527.0187 1.2495-.0425 2.5109.2074 3.7434z",qe="c0 .805-.3018 1.576-1.1298 2.6109-.8772 1.0963-1.6156 1.7237-2.5886 2.4615l0-4.8049c.2212-.5586.5474-1.0108.98-1.358.4312-.3458.868-.5194 1.3104-.5194.7308 0 1.1942.4144 1.3944 1.2404.0224.0672.0336.1904.0336.3696zm-.105-3.36c-.6034 0-1.2166.1666-1.841.5012-.6244.3332-1.2152.7798-1.7724 1.3356l0-10.1804-.7882 0 0 17.4367c0 .4928.1344.7392.4032.7392.1554 0 .3485-.1302.637-.3024.8166-.4873 1.3257-.8131 1.8788-1.1567.6308-.392 1.3412-.8497 2.2806-1.7457.6482-.651 1.1172-1.3076 1.4084-1.9684.2898-.6622.4354-1.3174.4354-1.9684 0-.9632-.2562-1.6478-.7686-2.0524-.5796-.4256-1.2054-.6384-1.8732-.6384z",$t="m0 0-.7875.2813 0-6.4406-4.5281 1.9688 0-16.7063.7594-.3375 0 6.5531 4.5563-2.0813 0 16.7625zm-.7875-9 0-4.5-3.7688 1.6594 0 4.5 3.7688-1.6594z";function Je(i,e,t,n,o){let{context:s,camera:r}=i,l="",a="";switch(t){case 0:l=`m ${e.Bounds.x+r.x-2} ${e.Bounds.y+r.y+16}`,l+=$t;break;case 1:E(i,"\uE262",e.Bounds.x-n,e.Bounds.y+3,o,e.Selected);break;case 2:l=`m ${e.Bounds.x+r.x-2} ${e.Bounds.y+r.y+10}`,l+=_t;break;case-2:a=`m ${e.Bounds.x+r.x-15} ${e.Bounds.y+r.y+4}`,a+=qe;case-1:l=`m ${e.Bounds.x+r.x-5} ${e.Bounds.y+r.y+4}`,l+=qe,E(i,"\uE260",e.Bounds.x-n,e.Bounds.y+3,o,e.Selected);break;default:break}}function Re(i,e,t,n,o,s,r){i.context.fillStyle=i.theme.NoteElements;let l=e.Clefs.filter(f=>f.Staff===r);if(!l){console.error("(RenderKeySignature): Something went very wrong here");return}let a=l[0].Type,u=zt(a,t);u.Lines.forEach((f,h)=>{u.Accidental==="#"?E(i,"\uE262",e.Bounds.x+o+h*10,e.GetNotePositionOnLine(f,r)+2.5,s,!1):E(i,"\uE260",e.Bounds.x+o+h*10,e.GetNotePositionOnLine(f,r)+2.5,s,!1)})}function zt(i,e){let t={Accidental:"",Lines:[]},n=te.get(e),o="";if(i===""||!i||!e||e==="")return console.error("ClefString or KeyString missing"),t;if(!n)return console.error("Notes undefined/null"),t;switch(n.length>0&&(n[0].includes("#")?o="#":o="b"),t.Accidental=o,i){case"bass":t.Lines=et(n,o),t.Lines=[...t.Lines.map(s=>s+=2)];break;case"treble":t.Lines=et(n,o);break;default:}return t}function et(i,e){let t=[];return e==="#"?t=[11,14,10,13,16,12,15].slice(0,i.length):t=[15,12,16,13,17,14,18].slice(0,i.length),t}var Kt=new Map([["p","\uE520"],["m","\uE521"],["f","\uE522"],["r","\uE523"],["s","\uE524"],["z","\uE525"],["n","\uE526"]]),me=class{constructor(e,t,n){this.Symbol=e,this.Selected=!1,this.Staff=t,this.Beat=n,this.Bounds=new p(0,0,13*e.length,20)}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}};function tt(i,e,t,n){if(t.Symbol===""){console.error("(RenderDynamic): No Symbol String");return}if(t.Staff>=e.Staves.length){console.error("(RenderDynamic): Staff out of bounds of measure");return}let o=e.Voices[e.ActiveVoice].Divisions.filter(m=>m.Beat===t.Beat);if(o.length===0){console.error("(RenderDynamic): Division Beat not matching with dynamic");return}let s=o[0],r=e.Voices[e.ActiveVoice].Notes.filter(m=>m.Beat===s.Beat).sort((m,c)=>m.Line-c.Line),l=s.Bounds.y+11*10,a=r[r.length-1].Bounds.y,f=l>a?l:a+20,h=8;t.Bounds.x=s.Bounds.x+h,t.Bounds.y=f-10;for(let m=0;m<t.Symbol.length;m++)E(i,Kt.get(t.Symbol[m]),s.Bounds.x+h*(m+1)+m*5,f,n,t.Selected);Wt(i,t)}function Wt(i,e){i.context.strokeStyle="green",i.context.strokeRect(e.Bounds.x+i.camera.x,e.Bounds.y+i.camera.y,e.Bounds.width,e.Bounds.height),i.context.strokeStyle="black"}function ce(i,e,t){e.render(i,t)}function it(i,e,t){let{context:n,camera:o,theme:s}=i,r=10,l=1,a=e.Staves,u=e.Bounds.y+N(a,t.Num),f=y(a,t.Num);for(let h=0;h<5;h++){let m=`M${e.Bounds.x+o.x} 
    ${u+5*f-r*2+r*h+o.y} h 
    ${e.Bounds.width+e.XOffset} v ${l} h -${e.Bounds.width+e.XOffset} Z`;n.fillStyle=s.LineColour;let c=new Path2D(m);n.fill(c)}}function nt(i,e,t){i.Staves.forEach(o=>it(e,i,o)),i.Clefs.forEach(o=>{o.Beat===1&&i.PrevMeasure===null?ce(e,o,t):o.Beat===1&&i.PrevMeasure!==null&&i.PrevMeasure.PageLine!==i.PageLine?ce(e,o,t):o.Beat>1&&ce(e,o,t)}),i.RenderKey&&i.Staves.forEach(o=>{if(i.Clefs.length===0){console.error("Measure has no clefs, returning early from Rendering Key Signature");return}Re(e,i,i.KeySignature,i.Clefs[0].Type,34,t,o.Num)}),i.RenderTimeSig&&i.TimeSignature.render(e,i,t),i.Dynamics.forEach(o=>tt(e,i,o,t)),!1&&i.Voices[i.ActiveVoice].Divisions.forEach(o=>{e.context.strokeStyle="blue",e.context.strokeRect(o.Bounds.x+e.camera.x,o.Bounds.y+e.camera.y,o.Bounds.width,o.Bounds.height),o.Subdivisions.forEach((s,r)=>{r%2==0?e.context.fillStyle="rgba(0, 155, 0, 0.2)":e.context.fillStyle="rgba(255, 0, 0, 0.2)",e.context.fillRect(s.Bounds.x+e.camera.x,s.Bounds.y+e.camera.y,s.Bounds.width,s.Bounds.height),e.context.strokeStyle="blue",e.context.strokeRect(s.Bounds.x+e.camera.x,s.Bounds.y+e.camera.y,s.Bounds.width,s.Bounds.height)})})}var jt=9;function ot(i,e,t,n,o,s,r,l,a){Qt(i,e,t,o,r,l,a.Theme),nt(i,e,a.Theme),i.Staves.forEach(u=>{i.Voices.forEach(f=>{qt(i,e,u.Num,a.Theme,f),f.Divisions.filter(h=>h.Staff===u.Num&&h.Beat===1).forEach(h=>{i.Articulations.filter(m=>m.Beat==h.Beat&&m.Staff==h.Staff).forEach(m=>{m.Voice===f&&m.Render(e,f.Notes.filter(c=>c.Beat==h.Beat&&c.Staff==h.Staff),i.Staves,h,a.Theme)})}),e.context.fillStyle=e.theme.NoteElements,e.context.font="12px Bravura",e.context.fillText(i.Num.toString(),i.Bounds.x+8+e.camera.x-8,i.Bounds.y+10+e.camera.y)})})}function Yt(i){if(i.Staves.length===0)return new p(0,0,0,0);let e=new p(i.Bounds.x,0,i.GetBoundsWithOffset().width,5),n=15-i.Staves[0].BotLine;return e.y=i.Bounds.y+i.GetMeasureHeight()+(n*5-2.5),e}function Qt(i,e,t,n,o,s,r){let{context:l,camera:a}=e;i.Voices[i.ActiveVoice].Divisions.forEach(f=>{if(f.Bounds.IsHovered(t.x,t.y,a)){let h=i.GetLineHovered(t.y,f.Staff);if(i.Instrument.Staff===2&&(h.num=15,h.bounds=Yt(i)),h.bounds.y=i.GetNotePositionOnLine(h.num,f.Staff),n){let m={Beat:f.Beat,Duration:s,Line:h.num,Rest:o,Tied:!1,Staff:f.Staff,Tuple:!1,TupleIndex:0,TupleCount:1,Clef:"treble",Grace:!1,Voice:i.ActiveVoice,Accidental:0},c=new v(m);o?le(e,e.context,f,e.camera,c,i,r):(ue(c,e,new p(f.Bounds.x+jt,h.bounds.y,0,0),!0,!1,0,r),Te([c],f,e,f.Staff,i,r))}}})}function qt(i,e,t,n,o){let{context:s,camera:r}=e;o.Divisions.filter(a=>a.Staff===t).forEach(a=>{let u=o.Notes.filter(f=>f.Beat===a.Beat&&f.Staff===a.Staff);if(u.sort((f,h)=>f.Line-h.Line),Ee(a.Beat,u,a.Staff)&&i.Voices[i.ActiveVoice]===o){le(e,s,a,r,u[0],i,n);return}Te(o.Notes,a,e,t,i,n)}),o.DivisionGroups.forEach(a=>{if(a.Divisions.length>0){let u=O(a.Notes,a.Divisions);a.StemDir||(a.StemDir=u);let f=a.Notes[0][0].Tuple,h=a.Beams.length>0;a.Stems.forEach(m=>{m.Render(e,n)}),a.Beams.forEach(m=>{m.Render(s,r,Z.BeamCount(a.Divisions[0].Duration,f),a.StemDir,n)}),a.Flags.forEach(m=>{m.Render(e,n)}),a.Divisions.forEach(m=>{let c=!1,d=o.Notes.filter(b=>b.Beat===m.Beat&&b.Staff===t&&!b.Grace);d.sort((b,S)=>b.Line-S.Line),d.forEach((b,S)=>{let g=ne(d,S,u);g&&(c=!0);let B=g?u===0?11:-11:0;if(b.Rest)le(e,s,m,r,b,i,n);else{ue(b,e,b.Bounds,b.Selected,g,u,n);let C=d.filter(L=>L.Accidental!==0);C.sort((L,A)=>L.Line-A.Line);let M=Qe(C);C.forEach((L,A)=>{Je(e,L,L.Accidental,M[A],n)})}}),d.forEach(b=>{let S=c&&u===0?11:0})})}}),Jt(e,i,n),Me(e,o.Divisions,o.Notes,0,i),ve(e,o.Divisions,o.Notes,0,i,n),i.Instrument.Staff===1&&(Me(e,o.Divisions,o.Notes,1,i),ve(e,o.Divisions,o.Notes,1,i,n))}function Jt(i,e,t){e.Voices[e.ActiveVoice].Notes.filter(n=>n.Grace).forEach(n=>{ue(n,i,n.Bounds,n.Selected,!1,0,t)})}function ne(i,e,t){let n=!1,o=0,s=0,r=i[e].Line;if(i.length<=1)return!1;for(let u=e+1;u<=i.length-1;u++){if(i[u].Grace)continue;let f=i[u].Line;if(f-r===u-e||f-r===e-e)s++;else break}for(let u=e-1;u>=0;u--){if(i[u].Grace)continue;let f=i[u].Line;if(r-f===e-u||r-f===e-e)o++;else break}let l=o+s+1,a=o+1;return l%2===0?n=t===0?a%2!==0:a%2===0:n=a%2===0,n}var de=class{constructor(e,t){this.Selected=!1;this.Editable=!1;this.Bounds=e,this.Division=t}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}Render(e,t){e.context.fillStyle=t.NoteElements,this.Selected&&(e.context.fillStyle=t.SelectColour),e.context.fillRect(this.Bounds.x+e.camera.x,this.Bounds.y+e.camera.y,this.Bounds.width,this.Bounds.height)}RenderBounds(e,t){e.fillStyle="rgba(255, 0, 0, 255)",e.fillRect(this.Bounds.x+t.x,this.Bounds.y+t.y,this.Bounds.width,this.Bounds.height)}};function ei(i,e,t,n){return i===0&&e===0||i===1&&e===2?t-=n:(i===1&&e===0||i===0&&e===2)&&(t+=n),t}function ti(i,e,t){return i===0?t>22:e<8}function st(i,e,t,n){let o=[],s=9,r=O(i,e),l=Number.MAX_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER,u,f,h=!1;i.forEach(S=>{S.forEach(g=>{g.Grace&&(h=!0),g.Line<l&&(l=g.Line,u=g),g.Line>a&&(a=g.Line,f=g)})});let m=N(n.Staves,t)+y(n.Staves,t)*5,c=We(n,{Divisions:e,Notes:i,CrossStaff:!1,Staff:t,Stems:[],Flags:[],Beams:[],StemDir:r},r),d=e.length>1&&e[0].Duration<=.25,b={highestLine:l,lowestLine:a,hNote:u,lNote:f,shouldBeam:d,beamDir:c,stemDir:r};return e.forEach((S,g)=>{ii(n,b,o,i[g],g,e,m,t,h)}),o}function ii(i,e,t,n,o,s,r,l,a){if(n.length===0)return;let u=9,{highestLine:f,lowestLine:h,hNote:m,lNote:c,shouldBeam:d,beamDir:b,stemDir:S}=e,g=o*(10/s.length-1),B=n,M=a?.6:1,L=B.filter(U=>U.Accidental!==0).length;L>0&&(u+=u*L-1),B.sort((U,j)=>U.Line-j.Line);let A=S===0?B[0].Bounds.x+10.25*M:B[0].Bounds.x+0*M;ne(B,0,S)&&(A=B[0].Bounds.x+0);let D=new de(new p(A,0,1.5,0),s[o]);S===0?(D.Bounds.y=B[B.length-1].Bounds.y+2,D.Bounds.height=m.Bounds.y-B[B.length-1].Bounds.y-35*M):(D.Bounds.y=B[0].Bounds.y+4,D.Bounds.height=c.Bounds.y-B[0].Bounds.y+35*M),ti(S,h,f)&&(D.Bounds.height=r-D.Bounds.y+i.Bounds.y),d&&(D.Bounds.height=ei(S,b,D.Bounds.height,g)),D.Staff=l,t.push(D)}var rt=9;function at(i,e,t,n,o,s){let r=n.Subdivisions.find(l=>l.Type===2);lt(i,e,n,r,{num:t,bounds:new p(0,0,0,0)},o,s)}function ut(i,e,t,n,o,s,r){let l=i.Voices[i.ActiveVoice].Divisions.find(f=>f.Bounds.IsHovered(t,n,o));if(!l){console.error("Beat Over Not Found");return}let a=l.Subdivisions.find(f=>f.Bounds.IsHovered(t,n,o));if(!a){console.error("Subdivision on beat not found");return}let u=i.GetLineHovered(n,l.Staff);i.Instrument.Staff===2&&(u.num=15),lt(i,e,l,a,u,s,r)}function lt(i,e,t,n,o,s,r,l=1){let a=i.Voices[i.ActiveVoice].Notes.filter(c=>c.Beat===t.Beat);if(a.length<1){console.error("No notes found in division");return}let u=a[0].Tuple;u&&e!==t.Duration&&(e=e/a[0].TupleDetails.Count);let f=P(i,t.Beat,t.Staff),h={Beat:t.Beat,Duration:e,Line:o.num,Rest:s,Tied:!1,Staff:t.Staff,Tuple:u,TupleDetails:a[0].TupleDetails,Clef:f,Grace:r,Voice:i.ActiveVoice,Accidental:0},m=new v(h);if(r){let c=n.Order;n.Type!==1&&(c=1),m.Order=c}t.Duration===e||r?(i.ClearRestNotes(t.Beat,t.Staff,i.ActiveVoice),i.AddNote(m,!0)):ni(h.Beat,h.Duration,i)&&si(i,h,t.Staff),Pe(i),i.CreateDivisions(),ft(i)}function ft(i){i.Voices.forEach(e=>{e.DivisionGroups.forEach(t=>{t.Stems=[],t.Beams=[],t.Flags=[],t.Stems.push(...st(t.Notes,t.Divisions,t.Staff,i)),t.Beams.push(...je(t,t.Stems,!1)),t.Divisions.length!==0&&t.Beams.length===0&&t.Flags.push(...ze(t))})})}function Pe(i){i.Voices.forEach((e,t)=>{var n=[];i.Staves.forEach(o=>{let s=$e(i,o.Num,t);n.push(...s)}),i.Voices[t].DivisionGroups=n})}function k(i,e){i.Voices.forEach(t=>{t.DivisionGroups.forEach(n=>{let{Divisions:o,Notes:s}=n,r=O(s,o);o.forEach(l=>{l.Direction=r;let a=t.Notes.filter(c=>c.Beat===l.Beat&&c.Staff===e);a.sort((c,d)=>c.Line-d.Line);let u=rt,f=a.filter(c=>c.Accidental!==0).length;f>0&&(u+=rt*f-1);let h=l.Subdivisions.find(c=>c.Type===2);var m=0;h&&(m=h.Bounds.x-l.Bounds.x),l.NoteXBuffer=u+m,a.forEach((c,d)=>{let S=ne(a,d,r)?r===0?11:-11:0;if(!c.Rest){if(c.Bounds.x=Math.floor(l.Bounds.x+u+m+S),c.Grace){let g=l.Subdivisions.find(B=>B.Order===c.Order&&B.Type===1);g||(g=l.Subdivisions.find(B=>B.Order===1&&B.Type===1)),g&&(c.Bounds.x=g.Bounds.x+4)}c.Bounds.y=i.GetNotePositionOnLine(c.Line,c.Staff)}})})})}),ft(i)}function ni(i,e,t,n=1){return i*e<=t.TimeSignature.top*(1/t.TimeSignature.bottom)}function oi(i,e,t,n){let o=t.filter(r=>r.Beat===e&&r.Staff===n),s=o.find(r=>r.Rest);return s&&o.length>1?console.error("Rest found on beat with multiple notes, beat: ",e):s&&o.length===1&&i.ClearRestNotes(e,o[0].Staff,i.ActiveVoice),s!==void 0}function si(i,e,t){let n=e.Duration,o=e.Beat;e.Rest&&(e.Line=y(i.Staves,t));let s=!1,r=-1,l=-1;i.Voices[i.ActiveVoice].Divisions.filter(a=>a.Staff===t).forEach((a,u)=>{if(s&&e.Rest&&(s=!1),n>=a.Duration&&o===a.Beat){i.ClearRestNotes(o,e.Staff,i.ActiveVoice);let f=n,h=!1,m=0;for(let b=u;b<i.Voices[i.ActiveVoice].Divisions.length;b++){if(f<=0&&!h)continue;let S=i.Voices[i.ActiveVoice].Notes.filter(g=>g.Beat==i.Voices[i.ActiveVoice].Divisions[b].Beat);S.length>0&&S[0].Rest&&(f-=i.Voices[i.ActiveVoice].Divisions[b].Duration,f<=0&&(h=!0,m=b))}if(h){for(let g=u;g<=m;g++)i.ClearRestNotes(i.Voices[i.ActiveVoice].Divisions[g].Beat,e.Staff,i.ActiveVoice);let b={Beat:a.Beat,Duration:n,Line:e.Line,Rest:e.Rest,Tied:!1,Staff:a.Staff,Tuple:!1,Clef:P(i,a.Beat,a.Staff),Grace:e.Grace,Voice:i.ActiveVoice,Accidental:0},S=new v(b);i.AddNote(S,!0),n=0;return}n>a.Duration&&s===!1&&!e.Rest&&(s=!0,r=a.Beat,l=a.Beat+(n-a.Duration)*i.TimeSignature.bottom);let c={Beat:a.Beat,Duration:a.Duration,Line:e.Line,Rest:e.Rest,Tied:s,Staff:a.Staff,Tuple:!1,Clef:P(i,a.Beat,a.Staff),Grace:e.Grace,Voice:i.ActiveVoice,Accidental:0},d=new v(c);s&&(d.SetTiedStartEnd(r,l),n-a.Duration<=0&&(s=!1)),n-=a.Duration,o+=a.Duration*i.TimeSignature.bottom,i.AddNote(d,!0)}else if(n<a.Duration&&o===a.Beat&&n>0){let f=i.Voices[i.ActiveVoice].Notes.filter(S=>S.Beat===a.Beat&&S.Staff===a.Staff);if(oi(i,o,f,a.Staff)){let S={Beat:a.Beat,Duration:n,Line:e.Line,Rest:e.Rest,Tied:s,Staff:a.Staff,Tuple:!1,Clef:P(i,a.Beat,a.Staff),Grace:e.Grace,Voice:i.ActiveVoice,Accidental:0},g=new v(S);s&&(g.SetTiedStartEnd(r,l),n-a.Duration<=0&&(s=!1)),n=0,i.AddNote(g,!0);return}let h={Beat:a.Beat,Duration:n,Line:e.Line,Rest:e.Rest,Tied:!1,Staff:a.Staff,Tuple:e.Tuple,TupleDetails:e.TupleDetails,Clef:P(i,a.Beat,a.Staff),Grace:e.Grace,Voice:i.ActiveVoice,Accidental:0},m=a.Duration-n,c=J(m).sort((S,g)=>S-g),d=a.Beat,b=a.Beat+m*i.TimeSignature.bottom;f.forEach(S=>{S.Duration=n,S.Tied=!0,S.SetTiedStartEnd(d,b);let g=a.Beat+n*i.TimeSignature.bottom;c.forEach((B,C)=>{let M=C<c.length-1,L={Beat:g,Duration:B,Line:S.Line,Rest:!1,Tied:!0,Staff:S.Staff,Tuple:S.Tuple,TupleDetails:S.TupleDetails,Clef:P(i,a.Beat,a.Staff),Grace:S.Grace,Voice:i.ActiveVoice,Accidental:0},A=new v(L);A.SetTiedStartEnd(d,b),i.AddNote(A,!0),g=g+B*i.TimeSignature.bottom})}),i.AddNote(new v(h),!0)}})}function ht(i,e){let t=0;for(let[n,o]of i)o.forEach(s=>{if(!(s instanceof v))return;let r=s,l=r.Duration,a=r.Duration/e;t=a;let u=r.Beat;r.Duration=a,r.Tuple=!0;let f={StartBeat:r.Beat,EndBeat:r.Beat+l*n.TimeSignature.bottom,Value:l,Count:e};r.TupleDetails=f;for(let h=1;h<e;h++){let m=new v({Beat:u+a*n.TimeSignature.bottom,Duration:a,Line:r.Line,Rest:!0,Tied:!1,Staff:r.Staff,Tuple:!0,TupleDetails:f,Clef:P(n,u+a*n.TimeSignature.bottom,r.Staff),Grace:r.Grace,Voice:n.ActiveVoice,Accidental:0});u=m.Beat,n.AddNote(m,!0)}});return t}function ri(i){let e=[];switch(i.top.toString()+"/"+i.bottom.toString()){case"9/8":e.push(2.5),e.push(4);break;case"4/4":default:e.push(3)}return e}var Ie=class{constructor(e,t,n=!1){this.Selected=!1,this.SelType=3,this.top=e,this.bottom=t,this.Editable=!0,this.TopPosition=[{x:0,y:0}],this.BotPosition=[{x:0,y:0}],this.Bounds=[new p(0,0,0,0)],this.Breakpoints=ri({top:e,bottom:t})}render(e,t,n){let o=mt(this.top),s=mt(this.bottom);t.Staves.forEach(r=>{E(e,o,this.TopPosition[r.Num].x,this.TopPosition[r.Num].y,n,this.Selected),E(e,s,this.BotPosition[r.Num].x,this.BotPosition[r.Num].y,n,this.Selected)})}GetMaxDuration(){let e=1/this.bottom;return this.top*e}SetBounds(e){this.Bounds=[],this.TopPosition=[],this.BotPosition=[],e.Staves.forEach(t=>{this.Bounds.push(new p(0,0,0,0)),this.TopPosition.push({x:0,y:0}),this.BotPosition.push({x:0,y:0});let n=e.Voices[e.ActiveVoice].Divisions.find(r=>r.Staff===t.Num);if(!n)return;let o=n.Bounds.y,s=y(e.Staves,t.Num);this.Bounds[t.Num].x=e.Bounds.x+e.XOffset-25,this.Bounds[t.Num].y=o+(s-4)*5,this.Bounds[t.Num].width=20,this.Bounds[t.Num].height=50,this.TopPosition[t.Num].x=this.Bounds[t.Num].x,this.TopPosition[t.Num].y=o+(s-2)*5,this.BotPosition[t.Num].x=this.Bounds[t.Num].x,this.BotPosition[t.Num].y=o+(s+2)*5})}IsHovered(e,t,n){return this.Bounds.filter(o=>o.IsHovered(e,t,n)).length>0}};function mt(i){let e;switch(i){case 0:e="\uE080";break;case 1:e="\uE081";break;case 2:e="\uE082";break;case 3:e="\uE083";break;case 4:e="\uE084";break;case 5:e="\uE085";break;case 6:e="\uE086";break;case 7:e="\uE087";break;case 8:e="\uE088";break;case 9:e="\uE089";break}return e}function ct(i){return new Ie(i.top,i.bottom)}var K=class{constructor(e){this.ID=e,this.Notes=[],this.Divisions=[],this.DivisionGroups=[]}};var oe=class{constructor(e,t,n=!1){this.ActiveVoice=0;this.Clefs=[];this.Staves=e.Staves,this.PrevMeasure=e.PrevMeasure,this.NextMeasure=e.NextMeasure,this.RunningID=t,this.ID=0,this.Num=1,this.Voices=[new K(0),new K(1),new K(2),new K(3)],n&&e.Notes.length>0&&e.Notes.forEach(o=>{(this.Voices[o.Voice]!==void 0||this.Voices[o.Voice]!==null)&&this.AddNote(o,!1,this.Voices[o.Voice])}),this.Message=e.Message,this.Selected=!1,this.Editable=!0,this.SelType=0,this.Instrument=e.Instrument,this.Line=0,this.Bounds=e.Bounds,this.Bounds.height=N(this.Staves),this.TimeSignature=ct(e.TimeSignature),this.KeySignature=e.KeySignature,this.Articulations=[],this.Dynamics=[],this.RenderClef=e.RenderClef,this.Instrument.Staff===2&&(this.RenderClef=!1),this.RenderKey=e.RenderKey,this.Camera=e.Camera,this.RenderTimeSig=e.RenderTimeSig,this.Page=e.Page,this.PageLine=e.Page.PageLines[e.Page.PageLines.length-1].Number,this.SetXOffset(),this.Barlines=e.Barlines,this.CreateDivisions(),this.Staves.forEach((o,s)=>{let r=new I(0,e.Clefs[s].Type,1,o.Num);r.SetBounds(this,o.Num),this.Clefs.push(r)}),this.TimeSignature.SetBounds(this)}GetLineHovered(e,t){let n=this.Camera,o=e-this.Bounds.y-n.y,s=Math.floor(o/5),r=s,l=new p(this.Bounds.x,0,this.Bounds.width+this.XOffset,5),a=this.Staves.find(f=>f.Num===t),u=N(this.Staves,t)/5;return r=s+a.TopLine,l.y=this.Bounds.y+5*r,{num:r-u,bounds:l}}GetNotePositionOnLine(e,t){return N(this.Staves,t)+this.Bounds.y+(e-this.Staves[t].TopLine)*5-2.5}GetBoundsWithOffset(){return new p(this.Bounds.x,this.Bounds.y,this.Bounds.width+this.XOffset,this.Bounds.height)}SetXOffset(){this.XOffset=0,this.RenderClef&&(this.XOffset+=30),this.RenderKey&&(this.XOffset+=te.get(this.KeySignature).length*11),this.RenderTimeSig&&(this.XOffset+=30),this.TimeSignature.SetBounds(this)}CreateDivisions(){this.Voices.forEach((e,t)=>{e.Divisions=[],this.Staves.forEach(n=>{e.Divisions.push(...Xe(this,e.Notes,n.Num,e,t)),_e(this,e.Divisions,n.Num),k(this,n.Num)})})}Reposition(e){this.Bounds.x=e.Bounds.x+e.Bounds.width+e.XOffset,this.CreateDivisions()}GetMeasureHeight(){return N(this.Staves)}GetVoiceIndex(e){let t=0,n=!1;return this.Voices.forEach((o,s)=>{if(o===e){t=s,n=!0;return}}),n||console.error("Voice not found in measure!"),t}AddNote(e,t=!1,n=this.Voices[this.ActiveVoice]){let o=this.GetVoiceIndex(n);if(e.Rest?this.ClearNonRestNotes(e.Beat,e.Staff,o):this.ClearRestNotes(e.Beat,e.Staff,o),e.SetID(this.RunningID.count),this.RunningID.count++,n.Notes.push(e),t){let s={messageString:"AddNote",messageData:{Message:{msg:"AddingNote",obj:e},MessageType:4}};this.Message(s)}}ClearNonRestNotes(e,t,n){for(let o=this.Voices[n].Notes.length-1;o>=0;o--)this.Voices[n].Notes[o].Beat===e&&this.Voices[n].Notes[o].Rest===!1&&this.Voices[n].Notes[o].Staff===t&&this.Voices[n].Notes.splice(o,1)}ClearRestNotes(e,t,n){for(let o=this.Voices[n].Notes.length-1;o>=0;o--)this.Voices[n].Notes[o].Beat===e&&this.Voices[n].Notes[o].Rest===!0&&this.Voices[n].Notes[o].Staff===t&&this.Voices[n].Notes.splice(o,1)}ClearMeasure(e){for(let t=this.Voices[this.ActiveVoice].Notes.length-1;t>=0;t--)this.Voices[this.ActiveVoice].Notes[t].Editable&&!e.includes(this.Voices[this.ActiveVoice].Notes[t])&&this.Voices[this.ActiveVoice].Notes.splice(t,1)}DeleteSelected(){for(let e=this.Voices[this.ActiveVoice].Notes.length-1;e>=0;e--)if(this.Voices[this.ActiveVoice].Notes[e].Selected&&this.Voices[this.ActiveVoice].Notes[e].Editable){let t=this.Voices[this.ActiveVoice].Notes[e].Beat,n=this.Voices[this.ActiveVoice].Notes[e].Duration,o=this.Voices[this.ActiveVoice].Notes[e].Staff,s=this.Voices[this.ActiveVoice].Notes[e].Tuple,r=this.Voices[this.ActiveVoice].Notes[e].TupleDetails;if(this.Voices[this.ActiveVoice].Notes.splice(e,1),this.Voices[this.ActiveVoice].Notes.filter(a=>a.Beat===t).length===0){let a=P(this,t,o),u={Beat:t,Duration:n,Line:y(this.Staves,o),Rest:!0,Tied:!1,Staff:o,Tuple:s,TupleDetails:r,Clef:a,Grace:!1,Voice:this.ActiveVoice,Accidental:0};this.AddNote(new v(u))}}for(let e=this.Dynamics.length-1;e>=0;e--)this.Dynamics[e].Selected&&this.Dynamics.splice(e,1)}GetMinimumWidth(){if(this.Voices[this.ActiveVoice].Notes.filter(t=>t.Rest!==!0).length===0)return He*4;let e=1;return this.Voices[this.ActiveVoice].Divisions.length*Ze}ReturnSelectableElements(){let e=[];return e.push(...this.Voices[this.ActiveVoice].Notes),e.push(...this.Clefs),e}IsHovered(e,t,n){return this.GetBoundsWithOffset().IsHovered(e,t,n)}ChangeTimeSignature(e,t,n){this.TimeSignature.top=e,this.TimeSignature.bottom=t}RecalculateBarlines(){this.Barlines[0].Bounds=new p(this.Bounds.x,this.Bounds.y,10,this.GetMeasureHeight()),this.Barlines[1].Bounds=new p(this.Bounds.x+this.GetBoundsWithOffset().width-10,this.Bounds.y,10,this.GetMeasureHeight())}GetLastClef(e){let t=this.Clefs.filter(n=>n.Staff===e).sort((n,o)=>o.Beat-n.Beat);return t.length===0?(console.error("A clef should exist on this staff, in this measure. Returning default Clef"),new I(0,"treble",1,0)):t[0]}};var ai=5,ui=24,li=5,dt=(ui-ai)*li;function gt(i,e){let t=0;if(e.DefaultStaffType)switch(e.DefaultStaffType){case"rhythm":t=2;break;case"grand":t=1;break;case"single":default:t=0}return{Position:{x:0,y:i},Staff:t,Staves:[new V(0)]}}var bt=(i,e,t,n,o,s)=>{let r=e.Staff===0?dt*2:dt,l={Instrument:e,PrevMeasure:null,NextMeasure:null,Bounds:new p(e.Position.x,t.PageLines[t.PageLines.length-1].LineBounds.y,150,r),TimeSignature:{top:4,bottom:4},KeySignature:"DMaj/Bmin",Notes:[],Clefs:[new I(0,"treble",1,0),new I(1,"bass",1,1)],Staves:[new V(0),new V(1)],RenderClef:!0,RenderTimeSig:!0,RenderKey:!0,Camera:n,Page:t,Message:o,Settings:s,Barlines:[new _(0,0),new _(1,2)]};return new oe(l,i)},Se=(i,e,t,n,o,s,r,l,a,u,f,h=!1,m,c=!1,d=[],b)=>{let S={Instrument:i,PrevMeasure:e,NextMeasure:t,Bounds:n,TimeSignature:o,KeySignature:s,Notes:d,Clefs:r,Staves:l,RenderClef:h,RenderTimeSig:!1,RenderKey:!1,Camera:a,Page:f,Message:m,Settings:b,Barlines:[new _(0,0),new _(1,0)]};return new oe(S,u,c)};var fi={left:80,right:80,top:80,bottom:80},Bt=7,hi=210*Bt,mi=297*Bt,X=class{constructor(e,t,n){this.Margins=fi,this.MarginAdj=[],this.Number=n,this.Bounds=new p(e,t,hi,mi),this.MarginAdj.push({Name:"left",Direction:"horizontal",Bounds:new p(this.Bounds.x+this.Margins.left-12.5,this.Bounds.y-25,25,25)}),this.PageLines=[],this.PageLines.push({Number:1,YPos:t+this.Margins.top,LineBounds:new p(this.Bounds.x-50,t+this.Margins.top-12.5,25,25)})}AddLine(e){let t=this.PageLines[this.PageLines.length-1],n={Number:t.Number+1,YPos:this.Bounds.y+this.Margins.top,LineBounds:new p(this.Bounds.x-50,t.LineBounds.y+e-12.5,25,25)};return this.PageLines.push(n),n}};var Ae=class{constructor(e){this.Instruments=e.Instruments,this.KeySignature=e.KeySignature,this.Measures=e.Measures,this.Pages=e.Pages}InputHover(e,t,n){this.Measures.forEach(o=>{o.GetBoundsWithOffset().IsHovered(e,t,n)&&o.Voices[o.ActiveVoice].Divisions.forEach(s=>{s.Bounds.IsHovered(e,t,n)&&o.Staves.forEach(r=>{k(o,r.Num)})})})}};function pt(i,e,t){var r;let n=new X(0,0,1);(r=i.PageSettings)!=null&&r.PageWidth&&(n.Bounds.width=i.PageSettings.PageWidth);let o={Instruments:[],KeySignature:[{key:"CMaj/Amin",measureNo:0}],Measures:[],Pages:[n]},s=o.Pages[0];return o.Instruments.push(gt(20,i)),o.Measures.push(bt({count:0},o.Instruments[0],s,e,t,i.MeasureSettings)),new Ae(o)}function Dt(i,e,t,n,o,s,r){var m;let a=i.Bounds.width,u=i.Bounds.height,f=i.Bounds.x,h=i.Bounds.y;if((m=s.PageSettings)!=null&&m.AutoSize&&(u=r[r.length-1].Bounds.y+r[r.length-1].GetMeasureHeight()+40,r.length<4&&(a=r[r.length-1].Bounds.x+r[r.length-1].GetBoundsWithOffset().width+40)),t.filter="blur(4px)",t.fillStyle=s.Theme.PageShadowColour,t.fillRect(f+n.x-4,h+n.y+4,a,u),t.filter="none",t.fillStyle=s.Theme.PageColour,t.fillRect(f+n.x,h+n.y,a,u),o){t.strokeStyle="rgba(51, 2, 16, 0.2)",t.beginPath(),t.setLineDash([10,10]),t.moveTo(f+i.Margins.left+n.x,h+n.y),t.lineTo(f+i.Margins.left+n.x,h+u+n.y),t.stroke(),t.beginPath(),t.setLineDash([10,10]),t.moveTo(f+a-i.Margins.right+n.x,h+n.y),t.lineTo(f+a-i.Margins.right+n.x,h+u+n.y),t.stroke(),t.beginPath(),t.setLineDash([10,10]),t.moveTo(f+n.x,h+i.Margins.top+n.y),t.lineTo(f+a+n.x,h+i.Margins.top+n.y),t.stroke(),t.beginPath(),t.setLineDash([10,10]),t.moveTo(f+n.x,h+u-i.Margins.bottom+n.y),t.lineTo(f+a+n.x,h+u-i.Margins.bottom+n.y),t.stroke(),t.strokeStyle="black";let c="rgba(51, 2, 16, 0.8)",d="rgba(2,51,16,0.8)";W(f+i.Margins.right+n.x,h+n.y,"down",c,t),W(f+a-i.Margins.left+n.x,h+n.y,"down",c,t),W(f+n.x,h+i.Margins.top+n.y,"right",c,t),W(f+a+n.x,h+i.Margins.top+n.y,"left",c,t),W(f+n.x,h+u-i.Margins.bottom+n.y,"right",c,t),W(f+a+n.x,h+u-i.Margins.bottom+n.y,"left",c,t),i.PageLines.forEach(b=>{W(f+n.x-25,h+b.LineBounds.y+n.y+12.5,"right",d,t),t.strokeStyle=d,t.beginPath(),t.setLineDash([10,10]),t.moveTo(f+n.x,h+b.LineBounds.y+12.5+n.y),t.lineTo(f+a+n.x,h+b.LineBounds.y+12.5+n.y),t.stroke()}),t.strokeRect(i.MarginAdj[0].Bounds.x+n.x,i.MarginAdj[0].Bounds.y+n.y,i.MarginAdj[0].Bounds.width,i.MarginAdj[0].Bounds.height),t.stroke()}}function W(i,e,t,n,o){switch(o.fillStyle=n,o.beginPath(),t){case"down":o.moveTo(i,e-8),o.lineTo(i-9,e-8-9*1.7),o.lineTo(i+9,e-8-9*1.7);break;case"right":o.moveTo(i-8,e),o.lineTo(i-8-9*1.7,e-9),o.lineTo(i-8-9*1.7,e+9);break;case"left":o.moveTo(i+8,e),o.lineTo(i+8+9*1.7,e-9),o.lineTo(i+8+9*1.7,e+9);break;case"up":o.moveTo(i,e+8),o.lineTo(i-9,e+8+9*1.7),o.lineTo(i+9,e+8+9*1.7);break;default:}o.fill()}var Ct=(i,e,t,n,o,s,r,l,a,u,f)=>{var h,m;e.fillStyle=u.Theme.BackgroundColour,e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,i.width,i.height),(h=u.PageSettings)!=null&&h.RenderBackground&&e.fillRect(0,0,i.width,i.height),e.restore(),(m=u.PageSettings)!=null&&m.RenderPage&&n.forEach(c=>{Dt(c,i,e,s,a,u,t)}),e.fillStyle=u.Theme.NoteElements,t.forEach((c,d)=>{let b={context:e,camera:s,theme:u.Theme},S=d===t.filter(g=>c.Instrument===g.Instrument).length-1;if(ot(c,b,o,S,r,d,l,f,u),d>0){let g=t.filter(B=>c.Instrument===B.Instrument);se(b,g[g.length-1],c,s)}se(b,null,c,s),se(b,c,null,s)})};var ge=class{constructor(e,t){this.Dragging=!1,this.x=e,this.y=t,this.oldX=e,this.oldY=t,this.Zoom=1,this.ZoomTarget=this.Zoom}SetDragging(e,t,n,o,s){var r;if(((r=o.CameraSettings)==null?void 0:r.DragEnabled)===!1){this.Dragging=!1;return}this.Dragging=e,this.Dragging?(this.DraggingX=t/s.Zoom,this.DraggingY=n/s.Zoom):(this.DraggingX=0,this.DraggingY=0,this.oldX=this.x,this.oldY=this.y)}DragCamera(e,t){return this.Dragging?(this.x=Math.floor(this.oldX+e-this.DraggingX),this.y=Math.floor(this.oldY+t-this.DraggingY),!0):!1}SetZoom(e){this.Zoom=e}};var Be=class{constructor(){this.Measures=[],this.Clefs=[],this.Notes=new Map,this.Elements=new Map}TrySelectElement(e,t,n,o,s,r,l){let a,u=[],f=this.Elements.get(e)?this.Elements.get(e):[];return k(e,0),u.push(...e.Voices[e.ActiveVoice].Notes),u.push(...e.Clefs),e.Voices[e.ActiveVoice].DivisionGroups.forEach(h=>{u.push(...h.Stems),u.push(...h.Beams),u.push(...h.Flags)}),u.push(...e.Barlines),u.push(...e.Dynamics),u.push(e.TimeSignature),u.forEach(h=>{if(h.IsHovered(t,n,o)&&h.Selected===!1){if(h.Selected=!0,f.push(h),h.SelType===1){let m=h,c={messageData:{MessageType:1,Message:{msg:"selected",obj:m}},messageString:"Selected Note"};if(r(c),m.Tied){let d=be(m,e);f.push(...d)}}a=h,this.Elements.set(e,f)}}),a}DeselectAllElements(e){for(let[t,n]of e)n.forEach(o=>{o.Selected=!1}),e.delete(t);return new Map}SelectElement(){return void 0}DeselectAll(){for(let[e,t]of this.Notes)t.forEach(n=>{n.Selected=!1}),this.Notes.delete(e);for(let[e,t]of this.Elements)t.forEach(n=>{n.Selected=!1}),this.Elements.delete(e)}DeselectNote(e){let t=-1;for(let[n,o]of this.Notes)o.forEach((s,r)=>{s===s&&(t=r)}),t>=0&&this.RemoveDeselected([t],n)}RemoveDeselected(e,t){e.sort();for(let n=e.length-1;n>=0;n--)this.Notes.get(t).splice(n,1);this.Notes.get(t).length===0&&this.Notes.delete(t)}SelectById(e,t){let n;return this.DeselectAll(),e.forEach(o=>{o.Voices[o.ActiveVoice].Notes.forEach(s=>{if(s.ID===t){s.Selected=!0,n=s;let r=[];r.push(s),s.Tied&&r.push(...be(s,o)),this.Elements.set(o,r)}})}),n}SelectMeasure(e){if(this.Measures.find(t=>t.ID===e.ID)){let t=this.Measures.indexOf(e);e.Selected=!1,this.Measures.splice(t,1)}else this.Measures.push(e),e.Selected=!0}SelectClef(e){if(this.Clefs.find(t=>t.ID===e.ID)){let t=this.Clefs.indexOf(e);e.Selected=!1,this.Clefs.splice(t,1)}else this.Clefs.map(t=>t.Selected=!1),this.Clefs=[],this.Clefs.push(e),e.Selected=!0}SelectNote(e,t,n,o,s){let r=!1;return e.Voices[e.ActiveVoice].Divisions.forEach(l=>{e.Voices[e.ActiveVoice].Notes.filter(u=>u.Beat===l.Beat).forEach(u=>{if(u.Bounds.IsHovered(t,n,o)){if(u.Selected=!0,this.Notes.has(e)){let h=this.Notes.get(e);h.find(m=>m===u)||(h.push(u),u.Tied&&h.push(...be(u,e)),this.Notes.set(e,h))}else{let h=[];h.push(u),u.Tied&&h.push(...be(u,e)),this.Notes.set(e,h)}r=!0}else if(u.Selected&&!s){let h=!0;u.Tied&&(h=e.Voices[e.ActiveVoice].Notes.filter(c=>c!==u&&c.Beat>=u.TiedStart&&c.Beat<=u.TiedEnd&&c.Line===u.Line&&c.Staff===u.Staff&&c.Selected===!0).length===0),h&&(this.DeselectNote(u),u.Selected=!1)}})}),!r&&!s?(this.DeselectAll(),!1):!0}};function be(i,e){let t=[],n=i.TiedStart,o=i.TiedEnd;return e.Voices[e.ActiveVoice].Notes.filter(r=>r!==i&&r.Beat>=n&&r.Beat<=o&&r.Staff===i.Staff&&r.Line===i.Line).forEach(r=>{r.Selected=!0,t.push(r)}),t}var pe=class{constructor(e,t,n,o){this.Type=e,this.Beat=t,this.Staff=n,this.Voice=o}Render(e,t,n,o,s){ci(e,this.Type,o,n,t,s)}};function ci(i,e,t,n,o,s){if(o.length==1&&o[0].Rest){console.error("Trying to render accent when there are no notes");return}o.sort((h,m)=>h.Line-m.Line);var r=0;t.Direction==0?r=o[o.length-1].Bounds.y+20:r=o[0].Bounds.y-6;let l=5,a=t.Bounds.y+y(n,t.Staff)*l-4*l-6,u=t.Bounds.y+y(n,t.Staff)*l+4*l+16;r>a&&t.Direction==1?r=a:r<u&&t.Direction==0&&(r=u);var f;switch(e){case 1:t.Direction==0?f="\uE4A1":f="\uE4A0";default:f="\uE4A0"}E(i,f,t.Bounds.x+t.NoteXBuffer,r,s,!1)}var di='{"Measures":[{"Clefs":[{"ID":0,"Position":{"x":43,"y":107.5},"Staff":0,"Bounds":{"x":43,"y":47.5,"width":30,"height":85},"Type":"treble","SelType":2,"Beat":1,"Selected":false,"Editable":true,"PostClef":false},{"ID":0,"Position":{"x":43,"y":237.5},"Staff":1,"Bounds":{"x":43,"y":197.5,"width":30,"height":85},"Type":"bass","SelType":2,"Beat":1,"Selected":false,"Editable":true,"PostClef":false}],"Staves":[{"Num":0,"Buffer":0,"TopLine":5,"BotLine":35,"MidLine":15},{"Num":1,"Buffer":1000,"TopLine":5,"BotLine":35,"MidLine":15}],"TimeSignature":{"Selected":false,"SelType":3,"top":4,"bottom":4,"Editable":true,"TopPosition":[{"x":97,"y":87.5},{"x":97,"y":237.5}],"BotPosition":[{"x":97,"y":107.5},{"x":97,"y":257.5}],"Bounds":[{"x":97,"y":77.5,"width":20,"height":50},{"x":97,"y":227.5,"width":20,"height":50}],"Breakpoints":[3]},"KeySignature":"DMaj/Bmin","Notes":[{"ID":8,"Beat":1,"Duration":0.25,"Line":16,"Rest":false,"Tied":false,"Staff":0,"Clef":"bass","Editable":true,"Grace":false,"Voice":0}],"Bounds":{"x":40,"y":47.5,"width":1098,"height":300},"ShowClef":true,"ShowTime":true}]}',Si='{"Measures":[{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":2,"Beat":1,"Duration":0.03125,"Line":18,"Rest":false,"Tied":false,"Staff":0},{"ID":54,"Beat":1,"Duration":0.125,"Line":1047,"Rest":false,"Tied":false,"Staff":1},{"ID":8,"Beat":1.125,"Duration":0.03125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":9,"Beat":1.5,"Duration":0.03125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":12,"Beat":1.625,"Duration":0.03125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":13,"Beat":2,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":58,"Beat":2,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1},{"ID":15,"Beat":2.5,"Duration":0.125,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":16,"Beat":3,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":60,"Beat":3,"Duration":0.125,"Line":1047,"Rest":false,"Tied":false,"Staff":1},{"ID":19,"Beat":3.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0}],"Bounds":{"x":100,"y":87.5,"width":383.3333333333333,"height":190},"ShowClef":true,"ShowTime":true},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":22,"Beat":1,"Duration":0.0625,"Line":18,"Rest":false,"Tied":false,"Staff":0},{"ID":63,"Beat":1,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1},{"ID":27,"Beat":1.25,"Duration":0.0625,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":28,"Beat":1.5,"Duration":0.0625,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":30,"Beat":1.75,"Duration":0.0625,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":67,"Beat":2,"Duration":0.125,"Line":1048,"Rest":false,"Tied":false,"Staff":1},{"ID":69,"Beat":2.5,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":543.3333333333333,"y":87.5,"width":233.33333333333334,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":33,"Beat":1,"Duration":0.25,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":70,"Beat":1,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":74,"Beat":1.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":36,"Beat":2,"Duration":0.25,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":37,"Beat":3,"Duration":0.25,"Line":16,"Rest":false,"Tied":false,"Staff":0}],"Bounds":{"x":776.6666666666666,"y":87.5,"width":173.33333333333334,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":41,"Beat":1,"Duration":0.25,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":75,"Beat":1,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":44,"Beat":2,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":89,"Beat":2,"Duration":0.25,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":46,"Beat":2.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":47,"Beat":3,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":91,"Beat":3,"Duration":0.25,"Line":1043,"Rest":false,"Tied":false,"Staff":1},{"ID":50,"Beat":3.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":51,"Beat":4,"Duration":0.125,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":92,"Beat":4,"Duration":0.25,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":53,"Beat":4.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0}],"Bounds":{"x":100,"y":375,"width":485,"height":190},"ShowClef":true,"ShowTime":true},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":85,"Beat":1,"Duration":1,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":86,"Beat":1,"Duration":1,"Line":14,"Rest":false,"Tied":false,"Staff":0}],"Bounds":{"x":645,"y":375,"width":305,"height":190},"ShowClef":false,"ShowTime":false}]}';var De=[{name:"Canon in C",file:di},{name:"Random FIle One",file:Si}];function yt(i,e,t){switch(e){case t.addmeasure:i.AddMeasure();break;case t.changeinputmode:i.ChangeInputMode();break;case t.value1:i.SetNoteValue(.03125);break;case t.value2:i.SetNoteValue(.0625);break;case t.value3:i.SetNoteValue(.125);break;case t.value4:i.SetNoteValue(.25);break;case t.value5:i.SetNoteValue(.5);break;case t.value6:i.SetNoteValue(1);break;case t.restInput:i.RestInput=!i.RestInput;break;case t.delete:i.Delete();break;case t.sharpen:i.Sharpen();break;case t.flatten:i.Flatten();break;case t.scaleToggle:i.AddClef();break;case t.save:i.Save();break;case t.load:i.LoadSheet(De[0].file);break;case t.test_tuplet:i.CreateTuplet(5);break;case t.debug_clear:localStorage.removeItem("persist"),localStorage.removeItem("camera_data");break;case t.beam:i.BeamSelectedNotes();break;case t.grace:i.GraceInput=!i.GraceInput;break;case t.change_timesig:i.ChangeTimeSig();break;case t.add_dynamic:i.AddDynamic("f");break;case t.cycle_voice:i.CycleActiveVoice();break;case t.add_barline:let n=4;i.ChangeBarline(n);break;case t.add_accent:i.AddArticulation(1);break;case t.add_clef:i.AddClef();case t.undo:i.Undo();break;case t.redo:i.Redo();break;default:}}function vt(i,e,t,n=1050){if(e.length===0)return;let s=e[0];if(!s){console.error("No page found!");return}let r=0,l=0,a=1,u=0,f=s.Bounds.width-(s.Margins.left+s.Margins.right);if(t===!1&&t!==null){i.forEach(h=>{h.PageLine=a});return}console.log("Setting pages for measures ----"),i.forEach((h,m)=>{u++;let c=h.GetMinimumWidth()+h.XOffset;(r+c>f||u>4)&&(a++,u=1,s.PageLines.length<a&&a<=5?s.AddLine(n):a>5&&(console.log("Considering adding a page because current line is: ",a),e[e.length-1]===s&&(e.push(new X(0,e.length*(297*7+100),e.length+1)),console.log("Adding a page!")),s=e[e.length-1],l=e.length-1,a=1,u=1),r=0),r+=c,h.Page=e[l],h.PageLine=a,m>19})}function Nt(i,e){var n,o;let t=0;return(o=(n=e.FormatSettings)==null?void 0:n.MeasureFormatSettings)!=null&&o.MaxWidth?t=e.FormatSettings.MeasureFormatSettings.MaxWidth:t=i.Bounds.width,t}function Mt(i,e,t,n){let o=e.Bounds.width-(e.Margins.left+e.Margins.right);e.PageLines.forEach(s=>{i.Instruments.forEach(r=>{let l=i.Measures.filter(f=>f.PageLine===s.Number&&f.Instrument===r&&f.Page===e),a=0;l.forEach(f=>{a+=f.GetMinimumWidth()+f.XOffset});let u=o-a;l.forEach((f,h)=>{if(f.Bounds.y=s.LineBounds.y+f.Instrument.Position.y,h===0){f.Bounds.x=e.Bounds.x+e.Margins.left,f.RenderClef=f.Instrument.Staff!==2,f.RenderTimeSig=!0,f.RenderKey=!0,f.SetXOffset();let c=Nt(e,n),d=f.GetMinimumWidth()+u/l.length,b=0;d<c?b=d:b=c,f.Bounds.width=b,f.CreateDivisions()}else{f.RenderClef=!1,f.RenderTimeSig=!1,f.RenderKey=!1,f.SetXOffset();let c=Nt(e,n),d=f.GetMinimumWidth()+u/l.length;var m=d;d>c&&(m=c),f.Bounds.width=m,l[h].Reposition(l[h-1]),f.CreateDivisions()}f.Clefs.forEach(c=>{c.SetBounds(f,c.Staff)}),f.TimeSignature.SetBounds(f)})})})}var Tt=(i,e,t,n,o,s)=>{let r={count:0};JSON.parse(o).Measures.forEach((a,u)=>{n.Staff===2&&(a.ShowClef=!1);let f=[];a.Notes.forEach((m,c)=>{let d={Beat:m.Beat,Duration:m.Duration,Line:m.Line,Rest:m.Rest,Tied:m.Tied,Staff:m.Staff,Tuple:!1,Clef:m.Clef,Editable:!0,Grace:m.Grace,Voice:m.Voice,Accidental:m.Accidental},b=new v(d);f.push(b)});let h=Se(n,null,null,a.Bounds,a.TimeSignature,a.KeySignature,a.Clefs,a.Staves,t,r,e,a.ShowClef,s,!0,f);i.Measures.length>0&&(h.PrevMeasure=i.Measures[i.Measures.length-1],i.Measures[i.Measures.length-1].NextMeasure=h),i.Measures.push(h),h.CreateDivisions()})},we=i=>{let e={Measures:[]};return i.Measures.forEach(t=>{let n=[];t.Voices.forEach((o,s)=>{o.Notes.forEach(r=>{r.Rest||n.push({ID:r.ID,Beat:r.Beat,Duration:r.Duration,Line:r.Line,Rest:r.Rest,Tied:r.Tied,Staff:r.Staff,Clef:r.Clef,Editable:!0,Grace:r.Grace,Voice:s,Accidental:r.Accidental})})}),e.Measures.push({Clefs:t.Clefs,Staves:t.Staves,TimeSignature:t.TimeSignature,KeySignature:t.KeySignature,Notes:n,Bounds:t.Bounds,ShowClef:t.RenderClef,ShowTime:t.RenderTimeSig})}),JSON.stringify(e)};function Lt(i,e,t){t.index<i.length-1&&i.splice(t.index+1),i.push(e),t.index=i.length-1}function Et(i){i.StateIndex.index!==0&&(i.StateIndex.index-=1,i.LoadSheet(i.StateStack[i.StateIndex.index]),console.log(i.StateStack[i.StateIndex.index]))}function xt(i){i.StateIndex.index!==i.StateStack.length-1&&(i.StateIndex.index+=1,i.LoadSheet(i.StateStack[i.StateIndex.index]))}function Rt(i){let e={Measures:[]},t=he(),n={top:4,bottom:3},o="CMaj/Amin",s=[],r=[];return i.Measures.forEach((l,a)=>{let u=[],f=[];l.Staves.forEach(c=>{u.push(new V(c.Number))}),l.Clefs.forEach((c,d)=>{f.push(new I(d,c.Type,1,c.Staff))}),a===0&&(s=f,r=u),f.length===0&&(f=s),u.length!==r.length&&(u=r);let h=[];l.TimeSignature.top!==0&&l.TimeSignature.bottom!==0&&(n=l.TimeSignature),l.Key!==""&&(o=l.Key),l.Notes.forEach(c=>{let d="treble",b=f.find(g=>g.Staff===c.Staff);b&&(d=b.Type);let S=0;t.forEach(g=>{if(g.NoteString===c.NoteName){S=g.Line;return}}),d==="bass"&&(S-=12),h.push({ID:c.ID,Beat:c.Beat,Duration:c.Duration,Line:S,Rest:!1,Tied:!1,Staff:c.Staff,Clef:d,Editable:!0,Grace:!1,Voice:0,Accidental:c.Alter})});let m={Clefs:f,Staves:u,TimeSignature:n,KeySignature:o,Notes:h,Bounds:new p(0,0,0,0),ShowClef:!1,ShowTime:!1};e.Measures.push(m)}),e}var Ce=class{constructor(e,t,n,o,s,r=!1){this.GraceInput=!1;this.PlaybackTimer=0;this.Playing=!1;this.PlaybackTempo=120;this.PlaybackMeasureIndex=0;this.AudioContext=null;this.StateStack=[];this.StateIndex={index:0};this.CanDragCamera=!0;var u,f;this.Config=s,this.PitchMap=he(),this.Message=Q(),this.NotifyCallback=o,this.Debug=!0,this.Canvas=e,this.Container=t,this.Selector=new Be,this.Context=n,this.Load=r,this.RunningID={count:0},this.CamDragging=!1,this.DraggingPositions={x1:0,y1:0,x2:0,y2:0};let l=0,a=20;(u=this.Config.CameraSettings)!=null&&u.StartingPosition&&(l=this.Config.CameraSettings.StartingPosition.x,a=this.Config.CameraSettings.StartingPosition.y),this.Camera=new ge(l,a),this.Camera.Zoom=1,this.NoteValue=.5,this.StartDragY=0,this.EndDragY=0,this.DragLining=!1,this.Load||(this.Sheet=pt(this.Config,this.Camera,this.NotifyCallback)),this.NoteInput=!1,this.RestInput=!1,this.Formatting=!1,(f=this.Config.CameraSettings)!=null&&f.Zoom&&(this.Camera.Zoom=this.Config.CameraSettings.Zoom,this.SetCameraZoom(this.Camera.Zoom),this.ResizeMeasures(this.Sheet)),this.Update(0,0),this.SaveToUndoStack(),this.RealtimeUpdate(this)}Hover(e,t){if(this.MouseX=e,this.MouseY=t,e=e/this.Camera.Zoom,t=t/this.Camera.Zoom,this.CanDragCamera&&this.Camera&&this.Camera.DragCamera(e,t)){this.Update(e,t);return}this.DraggingNote&&(this.DragNote(e,t),this.Update(e,t)),this.Formatting&&this.DragLining&&(this.DragLiner(e,t),this.Update(e,t)),this.NoteInput&&this.Sheet.InputHover(e,t,this.Camera),this.Update(e,t)}Delete(){for(let[e,t]of this.Selector.Elements)e.DeleteSelected(),e.CreateDivisions();this.ResizeMeasures(this.Sheet)}Input(e,t,n){e=e/this.Camera.Zoom,t=t/this.Camera.Zoom,!this.NoteInput&&this.Formatting&&this.SelectLiner(e,t);let o=this.Sheet.Measures.find(r=>r.GetBoundsWithOffset().IsHovered(e,t,this.Camera));if(o===void 0){n||(this.Selector.DeselectAll(),this.Message=Q(),this.Message.messageString="msr undefined",this.NotifyCallback(this.Message),this.Update(e,t));return}if(this.NoteInput)this.NoteInput&&(ut(o,this.NoteValue,e,t,this.Camera,this.RestInput,this.GraceInput),this.ResizeMeasures(this.Sheet),this.SaveToUndoStack());else{n||(this.Selector.Elements=this.Selector.DeselectAllElements(this.Selector.Elements)),(this.Selector.TrySelectElement(o,e,t,this.Camera,n,this.NotifyCallback,this.Selector.Elements)===void 0&&this.Config.FormatSettings.MeasureFormatSettings.Selectable===!0||this.Config.FormatSettings.MeasureFormatSettings.Selectable===void 0)&&this.Selector.SelectMeasure(o),this.DraggingNote||(this.DraggingNote=!0);let l=o.Voices[o.ActiveVoice].Divisions.find(a=>a.Bounds.IsHovered(e,t,this.Camera));l&&(this.StartLine=o.GetLineHovered(t,l.Staff).num)}let s=we(this.Sheet);localStorage.setItem("persist",s),localStorage.setItem("camera_data",JSON.stringify({Zoom:this.Camera.Zoom,X:this.Camera.x,Y:this.Camera.y})),this.Update(e,t)}Update(e,t){this.Render({x:e,y:t})}Render(e){Ct(this.Canvas,this.Context,this.Sheet.Measures,this.Sheet.Pages,e,this.Camera,this.NoteInput,this.RestInput,this.Formatting,this.Config,this.NoteValue)}RealtimeUpdate(e){if(e.Camera)if(e.Camera.Zoom<e.Camera.ZoomTarget-.02||e.Camera.Zoom>e.Camera.ZoomTarget+.02){e.CanDragCamera=!1;let n=e.Camera.Zoom+(e.Camera.ZoomTarget-e.Camera.Zoom)*.05,o=e.MouseX/e.Camera.Zoom,s=e.MouseY/e.Camera.Zoom;e.Camera.SetZoom(n),e.Context.setTransform(e.Camera.Zoom,0,0,e.Camera.Zoom,0,0);let r=e.MouseX/e.Camera.Zoom,l=e.MouseY/e.Camera.Zoom;e.Camera.x+=r-o,e.Camera.y+=l-s,e.Camera.oldX=e.Camera.x,e.Camera.oldY=e.Camera.y,e.Update(0,0)}else e.CanDragCamera=!0;if(this.Playing){if(console.log("Playback!"),this.Update(0,0),this.PlaybackMeasureIndex>=this.Sheet.Measures.length){console.log("playback index out of range"),this.Playing=!1;return}let t=this.Sheet.Measures[this.PlaybackMeasureIndex],n=this.AudioContext.currentTime-this.PlaybackTimer,o=t.TimeSignature.top/t.TimeSignature.bottom*this.PlaybackTempo/60;if(n>o&&(this.PlaybackTimer+=o,this.PlaybackMeasureIndex<this.Sheet.Measures.length?(this.PlaybackMeasureIndex+=1,t=this.Sheet.Measures[this.PlaybackMeasureIndex],t?(n=this.AudioContext.currentTime-this.PlaybackTimer,o=t.TimeSignature.top*this.PlaybackTempo/60):(console.log("msr is null"),this.Playing=!1,this.PlaybackMeasureIndex=0,this.AudioContext=null,this.PlaybackTimer=0)):(console.log("playback measure would go out of range here, stopping"),this.Playing=!1,this.PlaybackMeasureIndex=0,this.PlaybackTimer=0)),t){let s=this.Sheet.Measures[this.PlaybackMeasureIndex].Bounds.x,r=this.Sheet.Measures[this.PlaybackMeasureIndex].Bounds.width,a=n/o*100/100*r;s=t.Bounds.x+t.XOffset+a+this.Camera.x,this.Context.fillStyle="rgba(0, 0, 255, 0.4)",this.Context.fillRect(s,this.Sheet.Measures[this.PlaybackMeasureIndex].Bounds.y+this.Camera.y,5,this.Sheet.Measures[this.PlaybackMeasureIndex].Bounds.height),this.Context.fillStyle="black";let u=-(t.Bounds.y-300),f=this.Camera.y+(u-this.Camera.y)*.02;this.Camera.y=Math.round(f),this.Camera.oldY=this.Camera.y}}requestAnimationFrame(()=>{e.RealtimeUpdate(this)})}AddMeasure(){let e=this.Sheet.Measures[this.Sheet.Measures.length-1],t=0;this.Sheet.Instruments.forEach(n=>{let o=this.Sheet.Measures.filter(u=>u.Instrument===n),s=o[o.length-1],r=this.Sheet.Pages[this.Sheet.Pages.length-1].PageLines[this.Sheet.Pages[this.Sheet.Pages.length-1].PageLines.length-1],l=new p(t,r.LineBounds.y,150,e.Bounds.height),a=Se(n,s,null,l,e.TimeSignature,e.KeySignature,e.Clefs,e.Staves,this.Camera,this.RunningID,this.Sheet.Pages[this.Sheet.Pages.length-1],!1,this.NotifyCallback,!1,[],this.Config.MeasureSettings);a.Num=this.Sheet.Measures.filter(u=>u.Instrument===n).length+1,a.Barlines[1].Type=2,a.PrevMeasure.Barlines[1].Type===2&&(a.PrevMeasure.Barlines[1].Type=0),this.Sheet.Measures.push(a),s.NextMeasure=a,this.ResizeMeasures(this.Sheet)}),this.ResizeMeasures(this.Sheet),this.SaveToUndoStack()}ChangeInputMode(){this.NoteInput=!this.NoteInput}SelectLiner(e,t){let n;return this.DragLining||(this.LineNumber=-1),this.Sheet.Pages.forEach(o=>{o.PageLines.forEach(s=>{s.LineBounds.IsHovered(e,t,this.Camera)&&(n=s.LineBounds,this.DragLining||(this.StartDragY=t,this.DragLining=!0,this.LinerBounds=n,this.LineNumber=s.Number))})}),n}DragLiner(e,t){if(this.LinerBounds){this.LinerBounds.y=this.LinerBounds.y+(t-this.StartDragY);let n=this.Sheet.Pages[0];this.LinerBounds.y+12.5<=n.Bounds.y+n.Margins.top&&(this.LinerBounds.y=n.Bounds.y+n.Margins.top-12.5),this.StartDragY=t,this.Sheet.Measures.forEach(o=>{o.PageLine===this.LineNumber&&(o.Bounds.y=this.LinerBounds.y)}),this.ResizeMeasures(this.Sheet)}}DragNote(e,t){let n=this.Sheet.Measures.find(r=>r.GetBoundsWithOffset().IsHovered(e,t,this.Camera));if(n===void 0){this.DraggingNote=!1,this.StartLine=-1,this.EndLine=-1;return}let o=n.Voices[n.ActiveVoice].Divisions.find(r=>r.Bounds.IsHovered(e,t,this.Camera));o&&(this.EndLine=n.GetLineHovered(t,o.Staff).num);let s=this.EndLine-this.StartLine;for(let[r,l]of this.Selector.Elements)l.filter(a=>a.SelType===1).forEach(a=>{if(a.Selected&&a.Editable&&(a.Line+=s,k(r,a.Staff),s!==0)){let u={messageData:{MessageType:1,Message:{msg:"selected",obj:a}},messageString:"Selected Note"};this.Message=u,this.NotifyCallback(this.Message)}});this.StartLine=this.EndLine,this.ResizeMeasures(this.Sheet)}StopNoteDrag(){this.DraggingNote&&(this.StartLine=-1,this.EndLine=-1,this.DraggingNote=!1),this.DragLining&&(this.DragLining=!1)}SetCameraDragging(e,t,n){this.CanDragCamera&&this.Camera.SetDragging(e,t,n,this.Config,this.Camera)}AlterZoom(e,t,n,o=!1){if(o)this.Camera.ZoomTarget=this.Camera.Zoom+e;else{let s=t/this.Camera.Zoom,r=n/this.Camera.Zoom;this.Camera.SetZoom(this.Camera.Zoom+e),this.Context.setTransform(this.Camera.Zoom,0,0,this.Camera.Zoom,0,0);let l=t/this.Camera.Zoom,a=n/this.Camera.Zoom;this.Camera.x+=l-s,this.Camera.y+=a-r,this.Camera.oldX=this.Camera.x,this.Camera.oldY=this.Camera.y}this.Update(0,0)}SetCameraZoom(e){this.Camera.SetZoom(e),this.Camera.ZoomTarget=this.Camera.Zoom,this.Context.setTransform(this.Camera.Zoom,0,0,this.Camera.Zoom,0,0),this.Update(0,0)}SetSmoothCameraZoom(e){this.Camera.ZoomTarget=e}ResizeFirstMeasure(){this.Sheet.Measures[0].CreateDivisions();for(let e=1;e<this.Sheet.Measures.length;e++)this.Sheet.Measures[e].Reposition(this.Sheet.Measures[e-1]);this.Update(0,0)}ResizeMeasures(e){e.Instruments.forEach(t=>{var s,r,l;let n=e.Measures.filter(a=>a.Instrument===t);this.Sheet.Pages=[],this.Sheet.Pages.push(new X(0,0,1));let o=(n[0].Instrument.Staff===2,400);vt(n,this.Sheet.Pages,(s=this.Config.PageSettings)==null?void 0:s.UsePages,o),this.Sheet.Pages.forEach(a=>{Mt(this.Sheet,a,this.Camera,this.Config)}),(r=this.Config.CameraSettings)!=null&&r.CenterMeasures?this.CenterMeasures():(l=this.Config.CameraSettings)!=null&&l.CenterPage&&this.CenterPage(),n.forEach(a=>{Pe(a),a.Staves.forEach(u=>{k(a,u.Num)}),a.RecalculateBarlines()})}),this.Update(0,0)}SetNoteValue(e){this.NoteValue=e}SetAccidental(e){for(let[t,n]of this.Selector.Elements)n.forEach(o=>{if(o.SelType===1){let s=o;s.Accidental=e,this.Message=Q();let r={messageData:{MessageType:1,Message:{msg:"selected",obj:s}},messageString:"Selected Note"};this.Message=r,this.NotifyCallback(r)}});this.Update(0,0),this.SaveToUndoStack()}Sharpen(){for(let[e,t]of this.Selector.Elements)t.forEach(n=>{if(n.SelType===1){let o=n;o.Accidental+=1,o.Accidental>2&&(o.Accidental=2)}});this.Update(0,0),this.SaveToUndoStack()}Flatten(){for(let[e,t]of this.Selector.Elements)t.forEach(n=>{if(n.SelType===1){let o=n;o.Accidental-=1,o.Accidental<-2&&(o.Accidental=-2)}});this.Update(0,0),this.SaveToUndoStack()}ScaleToggle(){return this.Camera.Zoom!==1?this.Camera.Zoom=1:this.Camera.Zoom=1,this.Camera.Zoom}KeyInput(e,t){let n="";e.ctrlKey&&(n+="ctrl "),e.altKey&&(n+="alt "),e.shiftKey&&(n+="shift ");let o=n+e.key;yt(this,o,t)}SelectById(e){let t=this.Selector.SelectById(this.Sheet.Measures,e);return this.Update(0,0),t}ToggleFormatting(){this.Formatting=!this.Formatting,this.Formatting&&(this.NoteInput=!1,this.RestInput=!1)}SaveToUndoStack(){Lt(this.StateStack,this.Save(),this.StateIndex),this.Message=Q();let e={messageData:{MessageType:7,Message:{msg:"statechanged",obj:this.StateStack[this.StateIndex.index]}},messageString:"Latest State"};this.Message=e,this.NotifyCallback(e)}Undo(){Et(this),this.ResizeMeasures(this.Sheet)}Redo(){xt(this),this.ResizeMeasures(this.Sheet)}Save(){return we(this.Sheet)}LoadSheet(e){this.Sheet.Measures=[],Tt(this.Sheet,this.Sheet.Pages[0],this.Camera,this.Sheet.Instruments[0],e,this.NotifyCallback),this.ResizeMeasures(this.Sheet),this.Update(0,0)}LoadFromMXML(e){this.Sheet.Measures=[];let t=Rt(e);this.LoadSheet(JSON.stringify(t)),this.ResizeMeasures(this.Sheet),this.Update(0,0),this.SaveToUndoStack()}GetSaveFiles(){return De}CreateTuplet(e){this.NoteValue=ht(this.Selector.Elements,e),this.ResizeMeasures(this.Sheet),this.Update(0,0)}ChangeTimeSignature(e,t,n=!1){for(let[o,s]of this.Selector.Elements)o.ChangeTimeSignature(e,t,n);this.SaveToUndoStack()}CenterMeasures(){var n,o,s;let e=100;(o=(n=this.Config.FormatSettings)==null?void 0:n.MeasureFormatSettings)!=null&&o.MaxWidth&&(e=this.Config.FormatSettings.MeasureFormatSettings.MaxWidth);let t=(this.Canvas.clientWidth-(e+e/2)*this.Camera.Zoom)/4;if(this.Camera.x=t,this.Canvas.clientWidth<e*this.Camera.Zoom)this.SetCameraZoom(this.Canvas.clientWidth/e);else{let r=(s=this.Config.CameraSettings)!=null&&s.Zoom?this.Config.CameraSettings.Zoom:1;this.SetCameraZoom(r)}}CenterPage(){var r;let o=this.Sheet.Pages[0].Bounds.width+20;if(this.Canvas.clientWidth<o)this.SetCameraZoom(this.Canvas.clientWidth/o);else{let l=(r=this.Config.CameraSettings)!=null&&r.Zoom?this.Config.CameraSettings.Zoom:1;this.SetCameraZoom(l)}let s=this.Canvas.clientWidth-o*this.Camera.Zoom;this.Camera.x=s/2,this.Camera.oldX=this.Camera.x}AddNoteOnMeasure(e,t,n,o,s){at(e,t,n,o,s,this.GraceInput),this.SaveToUndoStack()}BeamSelectedNotes(){var e;for(let[t,n]of this.Selector.Elements)n.filter(o=>o.SelType===1).forEach((o,s)=>{s==0&&(e=o.Staff),o.Staff!==e&&t.Voices[t.ActiveVoice].Notes.filter(r=>r.Staff==o.Staff&&r.Beat==o.Beat).forEach(r=>{r.StaffGroup=e})});this.ResizeMeasures(this.Sheet)}AddStaff(e,t){let n=this.Sheet.Instruments[e];if(!n)return;let o=new V(n.Staves.length);n.Staves.push(new V(n.Staves.length)),this.Sheet.Measures.filter(r=>r.Instrument===n).forEach(r=>{r.Staves.push(o),r.Clefs.push(new I(r.Clefs.length-1,t,1,o.Num)),r.Bounds.height=N(r.Staves)})}FromPitchMap(e,t){return Ue(e,this.PitchMap,t)}ChangeBarline(e){for(let[t,n]of this.Selector.Elements)n.filter(o=>o.SelType===8).forEach(o=>{Oe(o.Position,e)&&(o.Type=e)});this.ResizeMeasures(this.Sheet),this.SaveToUndoStack()}AddClef(){let e="treble";for(let[t,n]of this.Selector.Elements)n.filter(o=>o.SelType===1).forEach(o=>{t.Clefs.push(new I(0,e,o.Beat,o.Staff))});this.SaveToUndoStack()}ChangeTimeSig(){let e=this.Sheet.Measures[0];e&&e.ChangeTimeSignature(3,4,!1),this.SaveToUndoStack()}AddDynamic(e){for(let[t,n]of this.Selector.Elements)n.filter(o=>o.SelType===1).forEach(o=>{t.Dynamics.push(new me(e,o.Staff,o.Beat))});this.SaveToUndoStack()}AddArticulation(e){for(let[t,n]of this.Selector.Elements)n.filter(o=>o.SelType===1).forEach(o=>{t.Articulations.push(new pe(e,o.Beat,o.Staff,t.Voices[t.ActiveVoice]))});this.SaveToUndoStack()}CycleActiveVoice(){this.Sheet.Measures.forEach(e=>{e.ActiveVoice+=1,e.ActiveVoice>3&&(e.ActiveVoice=0)})}SetPlaying(e,t,n){console.log("Trying to play here!"),this.Playing=!0,this.PlaybackTempo=t,this.AudioContext=n,this.PlaybackTimer=n.currentTime}};var x,gi=!1;function bi(i,e,t){let n=e.getBoundingClientRect(),o=t.clientX-n.left,s=t.clientY-n.top;i.Hover(o,s)}function Bi(i,e,t){t.preventDefault();let n=e.getBoundingClientRect(),o=t.clientX-n.left,s=t.clientY-n.top;t.buttons===1?i.Input(o,s,t.shiftKey):t.buttons===4&&i.SetCameraDragging(!0,o,s)}function pi(i,e,t){let n=e.getBoundingClientRect(),o=t.clientX-n.left,s=t.clientY-n.top;i.SetCameraDragging(!1,0,0),i.StopNoteDrag()}function Di(i,e,t){let n=t.key;i.KeyInput(t,e)}function Ci(i,e,t){if(t.ctrlKey){let n=e.getBoundingClientRect(),o=t.clientX-n.left,s=t.clientY-n.top;t.preventDefault(),t.deltaY*-.01>0?i.AlterZoom(.075,o,s,!0):i.AlterZoom(-.075,o,s,!0)}}function Pt(i,e,t,n){var o,s;t.width=n.clientWidth-50,((o=i.Config.CameraSettings)==null?void 0:o.CenterMeasures)===!0?i.CenterMeasures():(s=i.Config.CameraSettings)!=null&&s.CenterPage&&i.CenterPage(),i.AlterZoom(0,0,0),i.Update(0,0)}var It;(b=>{function i(S,g,B,C,M,L){var U,j;let A=S.getContext("2d"),D=new Ce(S,g,A,M,L);if(S.addEventListener("mousemove",T=>bi(D,S,T)),S.addEventListener("mousedown",T=>Bi(D,S,T)),S.addEventListener("mouseup",T=>pi(D,S,T)),B.addEventListener("keydown",T=>Di(D,C,T)),window.addEventListener("resize",()=>Pt(D,D.Context,S,g)),S.addEventListener("wheel",T=>Ci(D,S,T)),screen.orientation.addEventListener("change",T=>Pt(D,D.Context,S,g)),x=D,S.width=g.clientWidth,S.height=g.clientHeight,D.Update(0,0),(U=L.CameraSettings)!=null&&U.Zoom&&D.SetCameraZoom(L.CameraSettings.Zoom),(j=L.CameraSettings)!=null&&j.CenterMeasures&&D.CenterMeasures(),gi){let T=localStorage.getItem("persist");if(T!==null){let ye=JSON.parse(localStorage.getItem("camera_data"));D.LoadSheet(T),D.SetCameraZoom(ye.Zoom),D.Camera.x=ye.X,D.Camera.y=ye.Y,D.ResizeMeasures(D.Sheet)}}return D}b.CreateApp=i;function e(){x.ChangeInputMode()}b.ChangeInputMode=e;function t(S){x.SetAccidental(S)}b.SetAccidental=t;function n(){x.Sharpen()}b.Sharpen=n;function o(){x.Flatten()}b.Flatten=o;function s(S){x.SetNoteValue(S)}b.SetNoteValue=s;function r(){x.AddMeasure()}b.AddMeasure=r;function l(S){x.AddArticulation(S)}b.AddArticulation=l;function a(S,g){x.AddStaff(S,g)}b.AddStaff=a;function u(S,g,B,C,M){x.AddNoteOnMeasure(S,g,B,C,M)}b.AddNoteOnMeasure=u;function f(){x.Delete()}b.Delete=f;function h(S){return x.SelectById(S)}b.SelectById=h;function m(){x.ToggleFormatting()}b.ToggleFormatting=m;function c(){x.Delete()}b.DeleteSelected=c;function d(S,g,B=!1){x.ChangeTimeSignature(S,g,B)}b.ChangeTimeSignature=d})(It||(It={}));export{Ce as App,Q as ClearMessage,I as Clef,Ue as FromPitchMap,he as GeneratePitchMap,yt as KeyPress,Tt as LoadSheet,oe as Measure,re as MessageType,v as Note,Hi as ReturnLineFromMidi,Fe as ReturnMidiNumber,we as SaveSheet,It as sheet};
//# sourceMappingURL=entry.mjs.map